<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë©´ì ‘ ëª¨ì˜ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: #e8e8e8; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    
    /* í—¤ë” */
    header { text-align: center; padding: 2rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 2rem; }
    header h1 { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #10B981, #34D399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    header p { color: #888; }
    .user-info { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem; }
    .user-badge { background: rgba(16,185,129,0.2); color: #10B981; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; }
    .logout-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #888; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
    .logout-btn:hover { border-color: #EF4444; color: #EF4444; }
    
    /* ë¡œê·¸ì¸ í™”ë©´ */
    .login-container { max-width: 400px; margin: 100px auto; }
    .login-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 2.5rem; }
    .login-card h2 { text-align: center; margin-bottom: 2rem; color: #10B981; }
    .login-card .input-group { margin-bottom: 1.5rem; }
    .login-card label { display: block; margin-bottom: 0.5rem; color: #aaa; font-size: 0.9rem; }
    .login-card input { width: 100%; padding: 1rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: #e8e8e8; font-size: 1rem; }
    .login-card input:focus { outline: none; border-color: #10B981; }
    .login-btn { width: 100%; padding: 1rem; background: linear-gradient(135deg, #10B981, #059669); border: none; border-radius: 12px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16,185,129,0.4); }
    .login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .login-error { color: #EF4444; text-align: center; margin-top: 1rem; font-size: 0.9rem; }
    
    /* íƒ­ */
    .tabs { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; }
    .tab-btn { padding: 0.75rem 1.5rem; background: transparent; border: none; color: #888; cursor: pointer; font-size: 1rem; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s; }
    .tab-btn:hover { color: #ccc; }
    .tab-btn.active { color: #10B981; border-bottom-color: #10B981; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* ì¹´ë“œ */
    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .card h2 { font-size: 1.25rem; margin-bottom: 1rem; }
    
    /* ì…ë ¥ ìš”ì†Œ */
    input, textarea, select { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.75rem 1rem; color: #e8e8e8; font-size: 0.95rem; width: 100%; font-family: inherit; }
    input:focus, textarea:focus { outline: none; border-color: #10B981; }
    label { display: block; margin-bottom: 0.35rem; color: #888; font-size: 0.85rem; }
    
    /* ë²„íŠ¼ */
    .btn { padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 500; cursor: pointer; border: none; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #10B981, #059669); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16,185,129,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; }
    .btn-danger { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
    
    /* ì§„í–‰ë¥  */
    .progress-container { margin-bottom: 2rem; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .progress-title { font-size: 1.1rem; font-weight: 600; }
    .progress-count { color: #10B981; font-weight: 600; }
    .progress-bar { height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(135deg, #10B981, #34D399); border-radius: 6px; transition: width 0.5s ease; }
    .progress-labels { display: flex; justify-content: space-between; margin-top: 0.5rem; }
    .progress-label { font-size: 0.8rem; color: #666; }
    .progress-label.active { color: #10B981; font-weight: 600; }
    .progress-label.completed { color: #34D399; }
    
    /* ì§ˆë¬¸ ì„¤ì • */
    .question-item { display: grid; grid-template-columns: 40px 1fr 40px; gap: 1rem; align-items: start; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 1rem; }
    .question-num { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #10B981, #34D399); display: flex; align-items: center; justify-content: center; font-weight: 600; }
    .delete-btn { background: transparent; border: none; color: #666; cursor: pointer; padding: 0.5rem; }
    .delete-btn:hover { color: #EF4444; }
    
    /* ë…¹ìŒ ì˜ì—­ */
    .recording-area { text-align: center; padding: 3rem 2rem; }
    .question-display { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; }
    .question-label { color: #10B981; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .question-text { font-size: 1.3rem; font-weight: 500; line-height: 1.6; }
    
    /* íƒ€ì´ë¨¸ */
    .timer-display { font-size: 4rem; font-weight: 700; font-family: 'Courier New', monospace; margin: 1.5rem 0; }
    .timer-display.warning { color: #F59E0B; }
    .timer-display.danger { color: #EF4444; animation: pulse 0.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* íŒŒí˜• ì‹œê°í™” */
    .waveform-container { height: 100px; background: rgba(0,0,0,0.3); border-radius: 12px; margin: 1.5rem 0; overflow: hidden; position: relative; }
    .waveform-canvas { width: 100%; height: 100%; }
    .waveform-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 0.9rem; }
    
    /* ë…¹ìŒ ë²„íŠ¼ */
    .record-btn { width: 120px; height: 120px; border-radius: 50%; border: none; cursor: pointer; font-size: 3rem; transition: all 0.3s; margin: 1rem; }
    .record-btn.start { background: linear-gradient(135deg, #10B981, #059669); color: white; }
    .record-btn.start:hover { transform: scale(1.1); box-shadow: 0 8px 30px rgba(16,185,129,0.5); }
    .record-btn.stop { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; animation: recording-pulse 1.5s infinite; }
    @keyframes recording-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 50% { box-shadow: 0 0 0 20px rgba(239,68,68,0); } }
    .record-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
    
    /* ë…¹ìŒ ìƒíƒœ í‘œì‹œ */
    .recording-status { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 1rem 0; font-size: 1.1rem; }
    .recording-dot { width: 12px; height: 12px; background: #EF4444; border-radius: 50%; animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    
    /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ */
    .audio-player { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1rem; margin: 1rem 0; }
    .audio-player audio { width: 100%; }
    
    /* ê²°ê³¼ ì¹´ë“œ */
    .result-card { padding: 1.25rem; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 1rem; border: 2px solid transparent; transition: all 0.3s; cursor: pointer; }
    .result-card:hover { background: rgba(0,0,0,0.3); }
    .result-card.selected { border-color: #10B981; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .result-attempt { background: rgba(16,185,129,0.2); color: #10B981; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .result-date { color: #666; font-size: 0.85rem; }
    .result-question { color: #aaa; font-size: 0.9rem; margin-top: 0.5rem; }
    
    /* ë¶„ì„ ê²°ê³¼ */
    .analysis-section { margin-bottom: 2rem; padding: 1.5rem; background: rgba(0,0,0,0.2); border-radius: 12px; }
    .analysis-section h3 { font-size: 1.1rem; color: #10B981; margin-bottom: 1rem; }
    .transcript-box { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; line-height: 1.8; color: #ccc; }
    .feedback-box { background: rgba(16,185,129,0.1); border-left: 4px solid #10B981; padding: 1rem; border-radius: 0 8px 8px 0; line-height: 1.8; }
    
    /* ì•Œë¦¼ */
    .alert { padding: 1rem; border-radius: 12px; margin-bottom: 1rem; display: flex; align-items: start; gap: 0.75rem; }
    .alert-error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #EF4444; }
    .alert-success { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: #10B981; }
    .alert-warning { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: #F59E0B; }
    .alert-info { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); color: #93C5FD; }
    
    /* ëª¨ë²” ìŒì„± ë”°ë¼í•˜ê¸° */
    .sample-audio-section { background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .sample-audio-section h3 { color: #A78BFA; margin-bottom: 1rem; }
    
    /* í…Œì´ë¸” (ê´€ë¦¬ì) */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; }
    th { background: rgba(0,0,0,0.3); color: #aaa; font-size: 0.9rem; }
    tr { border-bottom: 1px solid rgba(255,255,255,0.05); }
    tr:hover { background: rgba(255,255,255,0.02); }
    
    /* ìƒíƒœ ë±ƒì§€ */
    .status-badge { padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .status-not-started { background: rgba(107,114,128,0.2); color: #9CA3AF; }
    .status-in-progress { background: rgba(245,158,11,0.2); color: #F59E0B; }
    .status-completed { background: rgba(16,185,129,0.2); color: #10B981; }
    
    /* ìˆ¨ê¹€ */
    .hidden { display: none !important; }
    
    /* ì´ë ¥ ë¹„êµ */
    .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    .comparison-card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.25rem; }
    .comparison-card h4 { color: #10B981; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .comparison-card .attempt-num { background: rgba(16,185,129,0.2); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      header h1 { font-size: 1.5rem; }
      .tabs { flex-wrap: wrap; }
      .tab-btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
      .timer-display { font-size: 3rem; }
      .record-btn { width: 100px; height: 100px; font-size: 2.5rem; }
      .question-item { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<div id="loginScreen" class="login-container">
  <div class="login-card">
    <h2>ğŸ¯ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ</h2>
    <div class="input-group">
      <label>ë©´ì ‘ë²ˆí˜¸</label>
      <input type="text" id="loginId" placeholder="ì˜ˆ: A001" autocomplete="off">
    </div>
    <div class="input-group">
      <label>ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label>
      <input type="password" id="loginPw" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" autocomplete="off">
    </div>
    <button class="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
    <div id="loginError" class="login-error hidden"></div>
  </div>
</div>

<!-- ë©”ì¸ í™”ë©´ -->
<div id="mainScreen" class="container hidden">
  <header>
    <h1>ğŸ¯ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ ì‹œìŠ¤í…œ</h1>
    <p>ì§ˆë¬¸ ë“£ê¸° â†’ ë‹µë³€ ë…¹ìŒ â†’ AI í”¼ë“œë°± ë°›ê¸°</p>
    <div class="user-info">
      <span class="user-badge" id="userBadge">ë©´ì ‘ë²ˆí˜¸: -</span>
      <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>
  
  <div class="tabs" id="mainTabs">
    <button class="tab-btn active" onclick="showTab('practice')">ğŸ¤ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ</button>
    <button class="tab-btn" onclick="showTab('results')">ğŸ“Š ì—°ìŠµ ê²°ê³¼</button>
    <button class="tab-btn" onclick="showTab('sample')">ğŸ§ ë”°ë¼í•˜ê¸° ì—°ìŠµ</button>
    <button class="tab-btn" id="settingsTabBtn" onclick="showTab('settings')">âš™ï¸ ì„¤ì •</button>
    <button class="tab-btn hidden" id="adminTabBtn" onclick="showTab('admin')">ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì</button>
  </div>
  
  <!-- ëª¨ì˜ì—°ìŠµ íƒ­ -->
  <div id="practice" class="tab-content active">
    <div class="card">
      <!-- ì§„í–‰ë¥  í‘œì‹œ -->
      <div class="progress-container">
        <div class="progress-header">
          <span class="progress-title">ì—°ìŠµ ì§„í–‰ë¥ </span>
          <span class="progress-count" id="progressCount">0 / 3 íšŒ</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-labels">
          <span class="progress-label" id="prog1">1íšŒì°¨</span>
          <span class="progress-label" id="prog2">2íšŒì°¨</span>
          <span class="progress-label" id="prog3">3íšŒì°¨</span>
        </div>
      </div>
      
      <!-- ì—°ìŠµ ì œí•œ ì•Œë¦¼ -->
      <div id="limitAlert" class="alert alert-warning hidden">
        <span>âš ï¸</span>
        <span>ì—°ìŠµ ê¸°íšŒ 3íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ íƒ­ì—ì„œ ë¶„ì„ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.</span>
      </div>
      
      <!-- ë…¹ìŒ ì˜ì—­ -->
      <div class="recording-area" id="recordingArea">
        <div class="question-display">
          <div class="question-label">ì§ˆë¬¸</div>
          <div class="question-text" id="questionText">ìš°ë¦¬ ê¸°ê´€ì— ì§€ì›í•œ ë™ê¸°ë¥¼ ì†Œê°œí•´ì£¼ì„¸ìš”.</div>
        </div>
        
        <div class="timer-display" id="timerDisplay">01:00</div>
        
        <div class="waveform-container">
          <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
          <div class="waveform-overlay" id="waveformOverlay">ğŸ¤ ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
        </div>
        
        <div class="recording-status hidden" id="recordingStatus">
          <span class="recording-dot"></span>
          <span>ë…¹ìŒ ì¤‘...</span>
        </div>
        
        <div>
          <button class="record-btn start" id="recordBtn" onclick="toggleRecording()">ğŸ¤</button>
        </div>
        <p style="color: #888; margin-top: 1rem;">ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 1ë¶„ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë©ë‹ˆë‹¤</p>
        
        <!-- ë…¹ìŒ ì™„ë£Œ í›„ ì¬ìƒ -->
        <div class="audio-player hidden" id="audioPlayer">
          <p style="margin-bottom: 0.5rem; color: #10B981;">âœ… ë…¹ìŒ ì™„ë£Œ</p>
          <audio id="audioPlayback" controls></audio>
          <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
            <button class="btn btn-secondary" onclick="resetRecording()">ğŸ”„ ë‹¤ì‹œ ë…¹ìŒ</button>
            <button class="btn btn-primary" onclick="submitRecording()" id="submitBtn">ğŸ“¤ ë¶„ì„ ìš”ì²­</button>
          </div>
        </div>
      </div>
      
      <!-- ë¶„ì„ ì¤‘ í‘œì‹œ -->
      <div class="hidden" id="analyzingArea" style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”„</div>
        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">AIê°€ ë‹µë³€ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        <p style="color: #888;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ì•½ 10~20ì´ˆ)</p>
      </div>
    </div>
  </div>
  
  <!-- ê²°ê³¼ íƒ­ -->
  <div id="results" class="tab-content">
    <div class="card">
      <h2>ğŸ“Š ì—°ìŠµ ì´ë ¥</h2>
      <div id="resultsList"></div>
      <div id="noResults" style="text-align: center; padding: 3rem; color: #666;">
        ğŸ“ ì•„ì§ ì—°ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëª¨ì˜ì—°ìŠµì„ ì§„í–‰í•´ì£¼ì„¸ìš”.
      </div>
    </div>
    
    <!-- ì´ë ¥ ë¹„êµ -->
    <div class="card hidden" id="comparisonCard">
      <h2>ğŸ“ˆ ì—°ìŠµ ì´ë ¥ ë¹„êµ</h2>
      <div class="comparison-grid" id="comparisonGrid"></div>
    </div>
    
    <!-- ìƒì„¸ ê²°ê³¼ -->
    <div class="card hidden" id="resultDetail">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
          <h2 id="detailTitle">ë¶„ì„ ê²°ê³¼</h2>
          <p id="detailDate" style="color: #888;"></p>
        </div>
        <button class="btn btn-primary" onclick="downloadPDF()">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>
      </div>
      
      <div class="analysis-section">
        <h3>ğŸ“‹ ì§ˆë¬¸</h3>
        <div class="transcript-box" id="detailQuestion"></div>
      </div>
      
      <div class="analysis-section">
        <h3>ğŸ¤ ë‚˜ì˜ ë‹µë³€ (ìŒì„±â†’í…ìŠ¤íŠ¸)</h3>
        <div class="transcript-box" id="detailTranscript"></div>
        <div class="audio-player" id="detailAudioPlayer" style="margin-top: 1rem;">
          <audio id="detailAudio" controls style="width: 100%;"></audio>
        </div>
      </div>
      
      <div class="analysis-section">
        <h3>ğŸ’¡ AI í”¼ë“œë°±</h3>
        <div class="feedback-box" id="detailFeedback"></div>
      </div>
    </div>
  </div>
  
  <!-- ë”°ë¼í•˜ê¸° ì—°ìŠµ íƒ­ -->
  <div id="sample" class="tab-content">
    <div class="card">
      <h2>ğŸ§ ë”°ë¼í•˜ê¸° ì—°ìŠµ</h2>
      <p style="color: #888; margin-bottom: 1.5rem;">ì—°ìŠµ ìŒì„±ì„ ë“£ê³  ë”°ë¼ ë§í•´ë³´ì„¸ìš”. ë¶„ì„ ì—†ì´ ììœ ë¡­ê²Œ ì—°ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      
      <div class="sample-audio-section">
        <h3>ğŸ“¢ ì—°ìŠµ ìŒì„±</h3>
        <div id="sampleAudioList">
          <p style="color: #888; text-align: center; padding: 2rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
      
      <div class="card" style="background: rgba(16,185,129,0.05);">
        <h3 style="color: #10B981; margin-bottom: 1rem;">ğŸ¤ ë”°ë¼í•˜ê¸° ë…¹ìŒ</h3>
        <div class="waveform-container">
          <canvas class="waveform-canvas" id="sampleWaveform"></canvas>
          <div class="waveform-overlay" id="sampleWaveformOverlay">ğŸ¤ ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
        </div>
        <div style="text-align: center; margin-top: 1rem;">
          <button class="record-btn start" id="sampleRecordBtn" onclick="toggleSampleRecording()">ğŸ¤</button>
        </div>
        <div class="audio-player hidden" id="samplePlayerResult">
          <p style="margin-bottom: 0.5rem; color: #10B981;">âœ… ë…¹ìŒ ì™„ë£Œ - ì¬ìƒí•´ì„œ í™•ì¸í•´ë³´ì„¸ìš”</p>
          <audio id="sampleAudioPlayback" controls style="width: 100%;"></audio>
          <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="resetSampleRecording()">ğŸ”„ ë‹¤ì‹œ ë…¹ìŒ</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ì„¤ì • íƒ­ (ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥) -->
  <div id="settings" class="tab-content">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>ğŸ“‹ ëª¨ì˜ì§ˆë¬¸ ì„¤ì •</h2>
        <button class="btn btn-primary" onclick="addQuestion()">â• ì§ˆë¬¸ ì¶”ê°€</button>
      </div>
      <div id="questionList"></div>
      <button class="btn btn-primary" style="margin-top: 1rem;" onclick="saveQuestions()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
    </div>
  </div>
  
  <!-- ê´€ë¦¬ì íƒ­ -->
  <div id="admin" class="tab-content">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>ğŸ‘¨â€ğŸ’¼ ì§€ì›ì í˜„í™©</h2>
        <button class="btn btn-secondary" onclick="refreshAdmin()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>ë©´ì ‘ë²ˆí˜¸</th>
              <th>ì—°ìŠµ íšŸìˆ˜</th>
              <th>ìƒíƒœ</th>
              <th>ë§ˆì§€ë§‰ ì—°ìŠµ</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody id="adminTable">
            <tr><td colspan="5" style="text-align: center; padding: 2rem; color: #666;">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- ì—°ìŠµ ìŒì„± ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) -->
    <div class="card">
      <h2>ğŸ§ ì—°ìŠµ ìŒì„± ê´€ë¦¬</h2>
      <p style="color: #888; margin-bottom: 1rem;">ì§€ì›ìê°€ ë”°ë¼í•  ì—°ìŠµ ìŒì„± íŒŒì¼ì„ ë“±ë¡í•©ë‹ˆë‹¤.</p>
      
      <div id="sampleAudioManage">
        <div class="alert alert-info" style="margin-bottom: 1rem;">
          <span>ğŸ’¡</span>
          <span>ì—°ìŠµ ìŒì„± íŒŒì¼ì€ ì™¸ë¶€ URLë¡œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Google Drive, Dropbox ë“±ì˜ ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ ì‚¬ìš©)</span>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <label>ìŒì„± ì œëª©</label>
          <input type="text" id="sampleAudioTitle" placeholder="ì˜ˆ: ì§€ì›ë™ê¸° ëª¨ë²”ë‹µë³€">
        </div>
        <div style="margin-bottom: 1.5rem;">
          <label>ìŒì„± íŒŒì¼ URL</label>
          <input type="text" id="sampleAudioUrl" placeholder="https://...">
          <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">â€» mp3, wav, webm ë“± ì˜¤ë””ì˜¤ íŒŒì¼ ì§ì ‘ ë§í¬</p>
        </div>
        <button class="btn btn-primary" onclick="addSampleAudio()">â• ì—°ìŠµ ìŒì„± ì¶”ê°€</button>
        
        <div style="margin-top: 2rem;">
          <h3 style="font-size: 1rem; margin-bottom: 1rem;">ğŸ“‚ ë“±ë¡ëœ ì—°ìŠµ ìŒì„±</h3>
          <div id="adminSampleAudioList">
            <p style="color: #666; text-align: center; padding: 1rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2>ğŸ“Š í†µê³„</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div style="background: rgba(16,185,129,0.1); padding: 1.5rem; border-radius: 12px; text-align: center;">
          <div style="font-size: 2.5rem; font-weight: 700; color: #10B981;" id="statTotal">0</div>
          <div style="color: #888;">ì „ì²´ ì§€ì›ì</div>
        </div>
        <div style="background: rgba(245,158,11,0.1); padding: 1.5rem; border-radius: 12px; text-align: center;">
          <div style="font-size: 2.5rem; font-weight: 700; color: #F59E0B;" id="statInProgress">0</div>
          <div style="color: #888;">ì§„í–‰ ì¤‘</div>
        </div>
        <div style="background: rgba(59,130,246,0.1); padding: 1.5rem; border-radius: 12px; text-align: center;">
          <div style="font-size: 2.5rem; font-weight: 700; color: #3B82F6;" id="statCompleted">0</div>
          <div style="color: #888;">ì™„ë£Œ (3íšŒ)</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== ìƒíƒœ ê´€ë¦¬ ====================
let currentUser = null;
let isAdmin = false;
let questions = [
  { id: 1, text: 'ìš°ë¦¬ ê¸°ê´€ì— ì§€ì›í•œ ë™ê¸°ë¥¼ ì†Œê°œí•´ì£¼ì„¸ìš”.' }
];
let practices = [];
let sampleAudios = []; // ì—°ìŠµ ìŒì„± ëª©ë¡
let mediaRecorder = null;
let audioChunks = [];
let audioBlob = null;
let audioUrl = null;
let isRecording = false;
let timerInterval = null;
let timeLeft = 60;
let audioContext = null;
let analyser = null;
let animationId = null;

// ë”°ë¼í•˜ê¸° ì—°ìŠµìš©
let sampleMediaRecorder = null;
let sampleAudioChunks = [];
let sampleIsRecording = false;
let sampleAudioContext = null;
let sampleAnalyser = null;
let sampleAnimationId = null;

// API ë² ì´ìŠ¤ URL (ê°œë°œ/í”„ë¡œë•ì…˜ ìë™ ê°ì§€)
const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';

// ==================== ì´ˆê¸°í™” ====================
document.addEventListener('DOMContentLoaded', function() {
  // ì €ì¥ëœ ì„¸ì…˜ í™•ì¸
  const savedUser = sessionStorage.getItem('interviewUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    showMainScreen();
  }
  
  // ì—”í„°í‚¤ ë¡œê·¸ì¸
  document.getElementById('loginPw').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') doLogin();
  });
  document.getElementById('loginId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') document.getElementById('loginPw').focus();
  });
});

// ==================== ë¡œê·¸ì¸ ====================
async function doLogin() {
  const id = document.getElementById('loginId').value.trim();
  const pw = document.getElementById('loginPw').value.trim();
  const errorEl = document.getElementById('loginError');
  
  if (!id || !pw) {
    errorEl.textContent = 'ë©´ì ‘ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    errorEl.classList.remove('hidden');
    return;
  }
  
  try {
    const res = await fetch(API_BASE + '/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ interviewId: id, password: pw })
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      errorEl.textContent = data.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      errorEl.classList.remove('hidden');
      return;
    }
    
    currentUser = { interviewId: id, isAdmin: data.isAdmin };
    isAdmin = data.isAdmin;
    sessionStorage.setItem('interviewUser', JSON.stringify(currentUser));
    
    showMainScreen();
    
  } catch (err) {
    errorEl.textContent = 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
    errorEl.classList.remove('hidden');
    console.error(err);
  }
}

function doLogout() {
  currentUser = null;
  isAdmin = false;
  sessionStorage.removeItem('interviewUser');
  practices = [];
  
  // ê´€ë¦¬ì íƒ­ ìˆ¨ê¸°ê¸°
  document.getElementById('adminTabBtn').classList.add('hidden');
  
  // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
  document.getElementById('resultsList').innerHTML = '';
  document.getElementById('resultDetail').classList.add('hidden');
  document.getElementById('comparisonCard').classList.add('hidden');
  document.getElementById('noResults').classList.remove('hidden');
  
  // ì§„í–‰ë¥  ì´ˆê¸°í™”
  document.getElementById('progressCount').textContent = '0 / 3 íšŒ';
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('limitAlert').classList.add('hidden');
  document.getElementById('recordBtn').disabled = false;
  
  // ë…¹ìŒ ì˜ì—­ ì´ˆê¸°í™”
  document.getElementById('recordingArea').classList.remove('hidden');
  document.getElementById('analyzingArea').classList.add('hidden');
  document.getElementById('audioPlayer').classList.add('hidden');
  document.getElementById('waveformOverlay').classList.remove('hidden');
  document.getElementById('recordingStatus').classList.add('hidden');
  document.getElementById('timerDisplay').textContent = '01:00';
  document.getElementById('timerDisplay').classList.remove('warning', 'danger');
  const recordBtn = document.getElementById('recordBtn');
  recordBtn.classList.remove('stop');
  recordBtn.classList.add('start');
  recordBtn.textContent = 'ğŸ¤';
  
  // ì²« ë²ˆì§¸ íƒ­ìœ¼ë¡œ ì´ë™
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('.tab-btn').classList.add('active');
  document.getElementById('practice').classList.add('active');
  
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('mainScreen').classList.add('hidden');
  document.getElementById('loginId').value = '';
  document.getElementById('loginPw').value = '';
  document.getElementById('loginError').classList.add('hidden');
}

function showMainScreen() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainScreen').classList.remove('hidden');
  document.getElementById('userBadge').textContent = 'ë©´ì ‘ë²ˆí˜¸: ' + currentUser.interviewId;
  
  // ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€
  if (currentUser.isAdmin) {
    document.getElementById('adminTabBtn').classList.remove('hidden');
    isAdmin = true;
  } else {
    document.getElementById('adminTabBtn').classList.add('hidden');
    isAdmin = false;
  }
  
  // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™” í›„ ìƒˆë¡œ ë¡œë“œ
  practices = [];
  
  loadQuestions();
  loadPractices();
  loadSampleAudios();
}

// ==================== íƒ­ ì „í™˜ ====================
function showTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(tabId).classList.add('active');
  
  if (tabId === 'admin' && isAdmin) {
    loadAdminData();
    renderAdminSampleAudios();
  }
  if (tabId === 'settings') {
    renderQuestions();
  }
  if (tabId === 'sample') {
    renderSampleAudios();
  }
}

// ==================== ì§ˆë¬¸ ê´€ë¦¬ ====================
async function loadQuestions() {
  try {
    const res = await fetch(API_BASE + '/api/practice?action=getQuestions');
    if (res.ok) {
      const data = await res.json();
      if (data.questions && data.questions.length > 0) {
        questions = data.questions;
      }
    }
  } catch (err) {
    console.error('ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', err);
  }
  
  // í˜„ì¬ ì§ˆë¬¸ í‘œì‹œ
  if (questions.length > 0) {
    document.getElementById('questionText').textContent = questions[0].text;
  }
  
  if (isAdmin) {
    renderQuestions();
  }
}

function renderQuestions() {
  const list = document.getElementById('questionList');
  if (!list) return;
  
  if (questions.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:2rem;color:#666;">ğŸ“‹ ì„¤ì •ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  let html = '';
  questions.forEach((q, i) => {
    html += `<div class="question-item">
      <span class="question-num">${i + 1}</span>
      <div>
        <label>ì§ˆë¬¸ ë‚´ìš©</label>
        <textarea rows="2" onchange="updateQuestion(${q.id}, this.value)">${q.text}</textarea>
      </div>
      <button class="delete-btn" onclick="deleteQuestion(${q.id})">ğŸ—‘ï¸</button>
    </div>`;
  });
  list.innerHTML = html;
}

function addQuestion() {
  const maxId = questions.reduce((max, q) => Math.max(max, q.id), 0);
  questions.push({ id: maxId + 1, text: '' });
  renderQuestions();
}

function updateQuestion(id, text) {
  const q = questions.find(q => q.id === id);
  if (q) q.text = text;
}

function deleteQuestion(id) {
  questions = questions.filter(q => q.id !== id);
  renderQuestions();
}

async function saveQuestions() {
  try {
    const res = await fetch(API_BASE + '/api/practice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'saveQuestions', questions })
    });
    
    if (res.ok) {
      alert('ì§ˆë¬¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      // í˜„ì¬ ì§ˆë¬¸ ì—…ë°ì´íŠ¸
      if (questions.length > 0) {
        document.getElementById('questionText').textContent = questions[0].text;
      }
    }
  } catch (err) {
    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  }
}

// ==================== ì—°ìŠµ ê¸°ë¡ ê´€ë¦¬ ====================
async function loadPractices() {
  if (!currentUser) return;
  
  try {
    const res = await fetch(API_BASE + '/api/practice?action=getPractices&interviewId=' + currentUser.interviewId);
    if (res.ok) {
      const data = await res.json();
      practices = data.practices || [];
    }
  } catch (err) {
    console.error('ì—°ìŠµ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
  }
  
  updateProgress();
  renderResults();
}

function updateProgress() {
  const count = practices.length;
  document.getElementById('progressCount').textContent = count + ' / 3 íšŒ';
  document.getElementById('progressFill').style.width = (count / 3 * 100) + '%';
  
  // ì§„í–‰ ë¼ë²¨ ì—…ë°ì´íŠ¸
  for (let i = 1; i <= 3; i++) {
    const label = document.getElementById('prog' + i);
    if (i <= count) {
      label.classList.add('completed');
      label.classList.remove('active');
    } else if (i === count + 1) {
      label.classList.add('active');
      label.classList.remove('completed');
    } else {
      label.classList.remove('active', 'completed');
    }
  }
  
  // 3íšŒ ì™„ë£Œ ì‹œ ì œí•œ
  if (count >= 3) {
    document.getElementById('limitAlert').classList.remove('hidden');
    document.getElementById('recordBtn').disabled = true;
  } else {
    document.getElementById('limitAlert').classList.add('hidden');
    document.getElementById('recordBtn').disabled = false;
  }
}

function renderResults() {
  const list = document.getElementById('resultsList');
  const noResults = document.getElementById('noResults');
  
  if (practices.length === 0) {
    list.innerHTML = '';
    noResults.classList.remove('hidden');
    document.getElementById('comparisonCard').classList.add('hidden');
    return;
  }
  
  noResults.classList.add('hidden');
  
  let html = '';
  practices.forEach((p, i) => {
    html += `<div class="result-card" onclick="viewResult(${i})">
      <div class="result-header">
        <span class="result-attempt">${i + 1}íšŒì°¨</span>
        <span class="result-date">${formatDate(p.timestamp)}</span>
      </div>
      <div class="result-question">${truncate(p.question, 50)}</div>
    </div>`;
  });
  list.innerHTML = html;
  
  // ì´ë ¥ ë¹„êµ í‘œì‹œ (2ê°œ ì´ìƒì¼ ë•Œ)
  if (practices.length >= 2) {
    renderComparison();
    document.getElementById('comparisonCard').classList.remove('hidden');
  }
}

function renderComparison() {
  const grid = document.getElementById('comparisonGrid');
  let html = '';
  
  practices.forEach((p, i) => {
    html += `<div class="comparison-card">
      <h4><span class="attempt-num">${i + 1}</span> ${i + 1}íšŒì°¨ ìš”ì•½</h4>
      <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 0.5rem;">${formatDate(p.timestamp)}</p>
      <p style="color: #ccc; line-height: 1.6;">${truncate(p.feedback, 150)}</p>
    </div>`;
  });
  
  grid.innerHTML = html;
}

function viewResult(index) {
  const p = practices[index];
  if (!p) return;
  
  document.getElementById('detailTitle').textContent = (index + 1) + 'íšŒì°¨ ë¶„ì„ ê²°ê³¼';
  document.getElementById('detailDate').textContent = formatDate(p.timestamp);
  document.getElementById('detailQuestion').textContent = p.question;
  document.getElementById('detailTranscript').textContent = p.transcript || '(í…ìŠ¤íŠ¸ ë³€í™˜ ê²°ê³¼ ì—†ìŒ)';
  document.getElementById('detailFeedback').innerHTML = p.feedback ? p.feedback.replace(/\n/g, '<br>') : '(í”¼ë“œë°± ì—†ìŒ)';
  
  // ì˜¤ë””ì˜¤ ì¬ìƒ (ì €ì¥í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í•­ìƒ ìˆ¨ê¹€)
  document.getElementById('detailAudioPlayer').classList.add('hidden');
  
  document.getElementById('resultDetail').classList.remove('hidden');
  
  // ì„ íƒ í‘œì‹œ
  document.querySelectorAll('.result-card').forEach((c, i) => {
    c.classList.toggle('selected', i === index);
  });
}

// ==================== ë…¹ìŒ ê¸°ëŠ¥ ====================
async function toggleRecording() {
  if (practices.length >= 3) {
    alert('ì—°ìŠµ ê¸°íšŒ 3íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!isRecording) {
    await startRecording();
  } else {
    stopRecording();
  }
}

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = (e) => {
      audioChunks.push(e.data);
    };
    
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioUrl = URL.createObjectURL(audioBlob);
      document.getElementById('audioPlayback').src = audioUrl;
      document.getElementById('audioPlayer').classList.remove('hidden');
      
      // ë…¹ìŒ ì¢…ë£Œ ì‹œ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    // UI ì—…ë°ì´íŠ¸
    const btn = document.getElementById('recordBtn');
    btn.classList.remove('start');
    btn.classList.add('stop');
    btn.textContent = 'â¹';
    document.getElementById('recordingStatus').classList.remove('hidden');
    document.getElementById('waveformOverlay').classList.add('hidden');
    
    // íƒ€ì´ë¨¸ ì‹œì‘
    timeLeft = 60;
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      if (timeLeft <= 0) {
        stopRecording();
      }
    }, 1000);
    
    // íŒŒí˜• ì‹œê°í™” ì‹œì‘
    startWaveform(stream);
    
  } catch (err) {
    alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
    console.error(err);
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  
  isRecording = false;
  clearInterval(timerInterval);
  stopWaveform();
  
  // UI ì—…ë°ì´íŠ¸
  const btn = document.getElementById('recordBtn');
  btn.classList.remove('stop');
  btn.classList.add('start');
  btn.textContent = 'ğŸ¤';
  btn.disabled = true;
  document.getElementById('recordingStatus').classList.add('hidden');
}

function resetRecording() {
  audioBlob = null;
  audioUrl = null;
  audioChunks = [];
  
  document.getElementById('audioPlayer').classList.add('hidden');
  document.getElementById('recordBtn').disabled = (practices.length >= 3);
  document.getElementById('waveformOverlay').classList.remove('hidden');
  timeLeft = 60;
  updateTimerDisplay();
  document.getElementById('timerDisplay').classList.remove('warning', 'danger');
}

function updateTimerDisplay() {
  const display = document.getElementById('timerDisplay');
  const mins = Math.floor(timeLeft / 60);
  const secs = timeLeft % 60;
  display.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
  
  display.classList.remove('warning', 'danger');
  if (timeLeft <= 10) {
    display.classList.add('danger');
  } else if (timeLeft <= 20) {
    display.classList.add('warning');
  }
}

// íŒŒí˜• ì‹œê°í™”
function startWaveform(stream) {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioContext.createAnalyser();
  const source = audioContext.createMediaStreamSource(stream);
  source.connect(analyser);
  
  analyser.fftSize = 256;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  
  const canvas = document.getElementById('waveformCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  function draw() {
    animationId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);
    
    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    const barWidth = (canvas.width / bufferLength) * 2.5;
    let x = 0;
    
    for (let i = 0; i < bufferLength; i++) {
      const barHeight = (dataArray[i] / 255) * canvas.height;
      
      const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
      gradient.addColorStop(0, '#10B981');
      gradient.addColorStop(1, '#34D399');
      
      ctx.fillStyle = gradient;
      ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
      
      x += barWidth + 1;
    }
  }
  
  draw();
}

function stopWaveform() {
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }
  if (audioContext) {
    audioContext.close();
    audioContext = null;
  }
}

// ==================== ë¶„ì„ ìš”ì²­ ====================
async function submitRecording() {
  if (!audioBlob) return;
  
  document.getElementById('recordingArea').classList.add('hidden');
  document.getElementById('analyzingArea').classList.remove('hidden');
  
  try {
    // 1. ìŒì„± â†’ í…ìŠ¤íŠ¸ ë³€í™˜
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.webm');
    
    console.log('Sending audio for transcription...', audioBlob.size, 'bytes');
    
    const transcribeRes = await fetch(API_BASE + '/api/transcribe', {
      method: 'POST',
      body: formData
    });
    
    const transcribeData = await transcribeRes.json();
    
    if (!transcribeRes.ok) {
      console.error('Transcribe error:', transcribeData);
      throw new Error(transcribeData.error || 'ìŒì„± ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
    
    const transcript = transcribeData.text;
    
    if (!transcript || transcript.trim() === '') {
      throw new Error('ìŒì„±ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë…¹ìŒí•´ì£¼ì„¸ìš”.');
    }
    
    console.log('Transcription successful:', transcript.substring(0, 50) + '...');
    
    // 2. AI ë¶„ì„ ìš”ì²­
    const question = questions[0]?.text || 'ìš°ë¦¬ ê¸°ê´€ì— ì§€ì›í•œ ë™ê¸°ë¥¼ ì†Œê°œí•´ì£¼ì„¸ìš”.';
    
    const analyzeRes = await fetch(API_BASE + '/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: `ë‹¹ì‹ ì€ ë©´ì ‘ ì½”ì¹˜ì…ë‹ˆë‹¤. ì•„ë˜ ì§ˆë¬¸ì— ëŒ€í•œ ì§€ì›ìì˜ ë‹µë³€ì„ ë¶„ì„í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.

[ì§ˆë¬¸]
${question}

[ì§€ì›ì ë‹µë³€]
${transcript}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:
1. ë‹µë³€ì˜ ì ì ˆì„± (ì§ˆë¬¸ì— ë§ëŠ” ë‹µë³€ì¸ì§€)
2. ê°•ì  (ì˜í•œ ë¶€ë¶„)
3. ê°œì„ ì  (ë³´ì™„í•  ë¶€ë¶„)
4. êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ

ì¹œì ˆí•˜ê³  ê±´ì„¤ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`
      })
    });
    
    if (!analyzeRes.ok) {
      throw new Error('AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
    
    const analyzeData = await analyzeRes.json();
    const feedback = analyzeData.content;
    
    // 3. ê²°ê³¼ ì €ì¥ (ìŒì„± íŒŒì¼ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ - ê°œì¸ì •ë³´ ë³´í˜¸)
    const practice = {
      attempt: practices.length + 1,
      question: question,
      transcript: transcript,
      feedback: feedback,
      // audioData ì œê±° - ì§€ì›ì ìŒì„± íŒŒì¼ ì €ì¥ ì•ˆ í•¨
      timestamp: new Date().toISOString()
    };
    
    const saveRes = await fetch(API_BASE + '/api/practice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'savePractice',
        interviewId: currentUser.interviewId,
        practice: practice
      })
    });
    
    if (!saveRes.ok) {
      throw new Error('ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
    
    practices.push(practice);
    
    // UI ì—…ë°ì´íŠ¸
    document.getElementById('analyzingArea').classList.add('hidden');
    document.getElementById('recordingArea').classList.remove('hidden');
    
    resetRecording();
    updateProgress();
    renderResults();
    
    // ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
    showTab('results');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    
    viewResult(practices.length - 1);
    
  } catch (err) {
    alert(err.message);
    console.error(err);
    document.getElementById('analyzingArea').classList.add('hidden');
    document.getElementById('recordingArea').classList.remove('hidden');
  }
}

function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// ==================== ë”°ë¼í•˜ê¸° ë…¹ìŒ ====================
async function toggleSampleRecording() {
  if (!sampleIsRecording) {
    await startSampleRecording();
  } else {
    stopSampleRecording();
  }
}

async function startSampleRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    sampleMediaRecorder = new MediaRecorder(stream);
    sampleAudioChunks = [];
    
    sampleMediaRecorder.ondataavailable = (e) => {
      sampleAudioChunks.push(e.data);
    };
    
    sampleMediaRecorder.onstop = () => {
      const blob = new Blob(sampleAudioChunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      document.getElementById('sampleAudioPlayback').src = url;
      document.getElementById('samplePlayerResult').classList.remove('hidden');
      stream.getTracks().forEach(track => track.stop());
    };
    
    sampleMediaRecorder.start();
    sampleIsRecording = true;
    
    const btn = document.getElementById('sampleRecordBtn');
    btn.classList.remove('start');
    btn.classList.add('stop');
    btn.textContent = 'â¹';
    document.getElementById('sampleWaveformOverlay').classList.add('hidden');
    
    // íŒŒí˜• ì‹œê°í™”
    sampleAudioContext = new (window.AudioContext || window.webkitAudioContext)();
    sampleAnalyser = sampleAudioContext.createAnalyser();
    const source = sampleAudioContext.createMediaStreamSource(stream);
    source.connect(sampleAnalyser);
    
    sampleAnalyser.fftSize = 256;
    const bufferLength = sampleAnalyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    const canvas = document.getElementById('sampleWaveform');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    function draw() {
      sampleAnimationId = requestAnimationFrame(draw);
      sampleAnalyser.getByteFrequencyData(dataArray);
      
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const barWidth = (canvas.width / bufferLength) * 2.5;
      let x = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = (dataArray[i] / 255) * canvas.height;
        const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
        gradient.addColorStop(0, '#10B981');
        gradient.addColorStop(1, '#34D399');
        ctx.fillStyle = gradient;
        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
        x += barWidth + 1;
      }
    }
    draw();
    
  } catch (err) {
    alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
    console.error(err);
  }
}

function stopSampleRecording() {
  if (sampleMediaRecorder && sampleMediaRecorder.state !== 'inactive') {
    sampleMediaRecorder.stop();
  }
  
  sampleIsRecording = false;
  
  if (sampleAnimationId) {
    cancelAnimationFrame(sampleAnimationId);
  }
  if (sampleAudioContext) {
    sampleAudioContext.close();
  }
  
  const btn = document.getElementById('sampleRecordBtn');
  btn.classList.remove('stop');
  btn.classList.add('start');
  btn.textContent = 'ğŸ¤';
}

function resetSampleRecording() {
  document.getElementById('samplePlayerResult').classList.add('hidden');
  document.getElementById('sampleWaveformOverlay').classList.remove('hidden');
  sampleAudioChunks = [];
}

// ==================== ì—°ìŠµ ìŒì„± ê´€ë¦¬ ====================
async function loadSampleAudios() {
  try {
    const res = await fetch(API_BASE + '/api/practice?action=getSampleAudios');
    if (res.ok) {
      const data = await res.json();
      sampleAudios = data.sampleAudios || [];
    }
  } catch (err) {
    console.error('ì—°ìŠµ ìŒì„± ë¡œë“œ ì‹¤íŒ¨:', err);
  }
  renderSampleAudios();
}

function renderSampleAudios() {
  const list = document.getElementById('sampleAudioList');
  if (!list) return;
  
  if (sampleAudios.length === 0) {
    list.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  let html = '';
  sampleAudios.forEach((audio, i) => {
    html += `<div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
      <p style="font-weight: 500; margin-bottom: 0.5rem;">${i + 1}. ${audio.title}</p>
      <audio controls style="width: 100%;">
        <source src="${audio.url}" type="audio/mpeg">
        ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </audio>
    </div>`;
  });
  list.innerHTML = html;
}

function renderAdminSampleAudios() {
  const list = document.getElementById('adminSampleAudioList');
  if (!list) return;
  
  if (sampleAudios.length === 0) {
    list.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  let html = '';
  sampleAudios.forEach((audio, i) => {
    html += `<div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
      <div style="flex: 1;">
        <p style="font-weight: 500;">${audio.title}</p>
        <p style="font-size: 0.8rem; color: #666; word-break: break-all;">${audio.url.substring(0, 50)}...</p>
      </div>
      <button class="btn btn-sm btn-danger" onclick="deleteSampleAudio(${i})">ğŸ—‘ï¸</button>
    </div>`;
  });
  list.innerHTML = html;
}

async function addSampleAudio() {
  const title = document.getElementById('sampleAudioTitle').value.trim();
  const url = document.getElementById('sampleAudioUrl').value.trim();
  
  if (!title || !url) {
    alert('ì œëª©ê³¼ URLì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    const res = await fetch(API_BASE + '/api/practice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'saveSampleAudios',
        sampleAudios: [...sampleAudios, { title, url }]
      })
    });
    
    if (res.ok) {
      sampleAudios.push({ title, url });
      document.getElementById('sampleAudioTitle').value = '';
      document.getElementById('sampleAudioUrl').value = '';
      renderAdminSampleAudios();
      alert('ì—°ìŠµ ìŒì„±ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  } catch (err) {
    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  }
}

async function deleteSampleAudio(index) {
  if (!confirm('ì´ ì—°ìŠµ ìŒì„±ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  sampleAudios.splice(index, 1);
  
  try {
    await fetch(API_BASE + '/api/practice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'saveSampleAudios',
        sampleAudios: sampleAudios
      })
    });
    renderAdminSampleAudios();
  } catch (err) {
    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  }
}

// ==================== ê´€ë¦¬ì ê¸°ëŠ¥ ====================
async function loadAdminData() {
  try {
    const res = await fetch(API_BASE + '/api/admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'getAll', adminId: currentUser.interviewId })
    });
    
    if (!res.ok) {
      throw new Error('ê´€ë¦¬ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
    }
    
    const data = await res.json();
    renderAdminTable(data.candidates);
    updateStats(data.candidates);
    
  } catch (err) {
    console.error(err);
    document.getElementById('adminTable').innerHTML = 
      '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #EF4444;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  }
}

function renderAdminTable(candidates) {
  const tbody = document.getElementById('adminTable');
  
  if (!candidates || candidates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #666;">ë“±ë¡ëœ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    return;
  }
  
  let html = '';
  candidates.forEach(c => {
    const statusClass = c.count === 0 ? 'not-started' : (c.count >= 3 ? 'completed' : 'in-progress');
    const statusText = c.count === 0 ? 'ë¯¸ì‹œì‘' : (c.count >= 3 ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘');
    
    html += `<tr>
      <td><strong>${c.interviewId}</strong></td>
      <td>${c.count} / 3 íšŒ</td>
      <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
      <td>${c.lastPractice ? formatDate(c.lastPractice) : '-'}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="viewCandidateDetail('${c.interviewId}')">ìƒì„¸</button>
        ${c.count > 0 ? `<button class="btn btn-sm btn-danger" onclick="resetCandidate('${c.interviewId}')">ì´ˆê¸°í™”</button>` : ''}
      </td>
    </tr>`;
  });
  
  tbody.innerHTML = html;
}

function updateStats(candidates) {
  const total = candidates.length;
  const inProgress = candidates.filter(c => c.count > 0 && c.count < 3).length;
  const completed = candidates.filter(c => c.count >= 3).length;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statInProgress').textContent = inProgress;
  document.getElementById('statCompleted').textContent = completed;
}

async function resetCandidate(interviewId) {
  if (!confirm(`${interviewId}ë‹˜ì˜ ì—°ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  try {
    const res = await fetch(API_BASE + '/api/admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'reset', interviewId: interviewId, adminId: currentUser.interviewId })
    });
    
    if (res.ok) {
      alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      loadAdminData();
    }
  } catch (err) {
    alert('ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  }
}

function viewCandidateDetail(interviewId) {
  alert('ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
}

function refreshAdmin() {
  loadAdminData();
}

// ==================== PDF ë‹¤ìš´ë¡œë“œ ====================
async function downloadPDF() {
  const title = document.getElementById('detailTitle').textContent;
  const date = document.getElementById('detailDate').textContent;
  const question = document.getElementById('detailQuestion').textContent;
  const transcript = document.getElementById('detailTranscript').textContent;
  const feedback = document.getElementById('detailFeedback').innerText;
  
  // HTMLë¡œ ë¦¬í¬íŠ¸ ìƒì„±
  const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ë©´ì ‘ ëª¨ì˜ì—°ìŠµ ê²°ê³¼</title>
  <style>
    body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; line-height: 1.8; }
    h1 { color: #10B981; border-bottom: 2px solid #10B981; padding-bottom: 10px; }
    h2 { color: #333; margin-top: 30px; }
    .box { background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .feedback { background: #e8f5e9; border-left: 4px solid #10B981; padding: 15px; }
    .date { color: #888; font-size: 14px; }
  </style>
</head>
<body>
  <h1>ğŸ¯ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ ê²°ê³¼</h1>
  <p class="date">${date}</p>
  <p><strong>ë©´ì ‘ë²ˆí˜¸:</strong> ${currentUser.interviewId}</p>
  
  <h2>ğŸ“‹ ì§ˆë¬¸</h2>
  <div class="box">${question}</div>
  
  <h2>ğŸ¤ ë‚˜ì˜ ë‹µë³€</h2>
  <div class="box">${transcript}</div>
  
  <h2>ğŸ’¡ AI í”¼ë“œë°±</h2>
  <div class="feedback">${feedback.replace(/\n/g, '<br>')}</div>
  
  <p style="margin-top: 40px; color: #888; font-size: 12px;">
    â€» ë³¸ ë¶„ì„ì€ AIê°€ ì‘ì„±í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.
  </p>
</body>
</html>`;
  
  // Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ìš´ë¡œë“œ
  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ë©´ì ‘ì—°ìŠµ_${currentUser.interviewId}_${title}.html`;
  a.click();
  URL.revokeObjectURL(url);
}

// ==================== ìœ í‹¸ë¦¬í‹° ====================
function formatDate(isoString) {
  if (!isoString) return '-';
  const d = new Date(isoString);
  return d.toLocaleDateString('ko-KR') + ' ' + d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}

function truncate(str, len) {
  if (!str) return '';
  return str.length > len ? str.substring(0, len) + '...' : str;
}
</script>
</body>
</html>

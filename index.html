<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë©´ì ‘ ëª¨ì˜ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #e8e8e8;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* í—¤ë” */
    header {
      text-align: center;
      padding: 2rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #10B981, #34D399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    header p {
      color: #888;
    }

    .user-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }

    .user-badge {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #888;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .logout-btn:hover {
      border-color: #EF4444;
      color: #EF4444;
    }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
    }

    .login-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 2.5rem;
    }

    .login-card h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: #10B981;
    }

    .login-card .input-group {
      margin-bottom: 1.5rem;
    }

    .login-card label {
      display: block;
      margin-bottom: 0.5rem;
      color: #aaa;
      font-size: 0.9rem;
    }

    .login-card input {
      width: 100%;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #e8e8e8;
      font-size: 1rem;
    }

    .login-card input:focus {
      outline: none;
      border-color: #10B981;
    }

    .login-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #10B981, #059669);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .login-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .login-error {
      color: #EF4444;
      text-align: center;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    /* íƒ­ */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 1rem;
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn:hover {
      color: #ccc;
    }

    .tab-btn.active {
      color: #10B981;
      border-bottom-color: #10B981;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ì¹´ë“œ */
    .card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    /* ì…ë ¥ ìš”ì†Œ */
    input,
    textarea,
    select {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: #e8e8e8;
      font-size: 0.95rem;
      width: 100%;
      font-family: inherit;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #10B981;
    }

    label {
      display: block;
      margin-bottom: 0.35rem;
      color: #888;
      font-size: 0.85rem;
    }

    /* ë²„íŠ¼ */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #EF4444, #DC2626);
      color: white;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    /* ì§„í–‰ë¥  */
    .progress-container {
      margin-bottom: 2rem;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .progress-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .progress-count {
      color: #10B981;
      font-weight: 600;
    }

    .progress-bar {
      height: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #10B981, #34D399);
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    .progress-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
    }

    .progress-label {
      font-size: 0.8rem;
      color: #666;
    }

    .progress-label.active {
      color: #10B981;
      font-weight: 600;
    }

    .progress-label.completed {
      color: #34D399;
    }

    /* ì§ˆë¬¸ ì„¤ì • */
    .question-item {
      display: grid;
      grid-template-columns: 40px 1fr 40px;
      gap: 1rem;
      align-items: start;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .question-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10B981, #34D399);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .delete-btn {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 0.5rem;
    }

    .delete-btn:hover {
      color: #EF4444;
    }

    /* ë…¹ìŒ ì˜ì—­ */
    .recording-area {
      text-align: center;
      padding: 3rem 2rem;
    }

    .question-display {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .question-label {
      color: #10B981;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .question-text {
      font-size: 1.3rem;
      font-weight: 500;
      line-height: 1.6;
    }

    /* íƒ€ì´ë¨¸ */
    .timer-display {
      font-size: 4rem;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      margin: 1.5rem 0;
    }

    .timer-display.warning {
      color: #F59E0B;
    }

    .timer-display.danger {
      color: #EF4444;
      animation: pulse 0.5s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* íŒŒí˜• ì‹œê°í™” */
    .waveform-container {
      height: 100px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      margin: 1.5rem 0;
      overflow: hidden;
      position: relative;
    }

    .waveform-canvas {
      width: 100%;
      height: 100%;
    }

    .waveform-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 0.9rem;
    }

    /* ë…¹ìŒ ë²„íŠ¼ */
    .record-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 3rem;
      transition: all 0.3s;
      margin: 1rem;
    }

    .record-btn.start {
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
    }

    .record-btn.start:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(16, 185, 129, 0.5);
    }

    .record-btn.stop {
      background: linear-gradient(135deg, #EF4444, #DC2626);
      color: white;
      animation: recording-pulse 1.5s infinite;
    }

    @keyframes recording-pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
      }

      50% {
        box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
      }
    }

    .record-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    /* ë…¹ìŒ ìƒíƒœ í‘œì‹œ */
    .recording-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin: 1rem 0;
      font-size: 1.1rem;
    }

    .recording-dot {
      width: 12px;
      height: 12px;
      background: #EF4444;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ */
    .audio-player {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .audio-player audio {
      width: 100%;
    }

    /* ê²°ê³¼ ì¹´ë“œ */
    .result-card {
      padding: 1.25rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 2px solid transparent;
      transition: all 0.3s;
      cursor: pointer;
    }

    .result-card:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    .result-card.selected {
      border-color: #10B981;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .result-attempt {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .result-date {
      color: #666;
      font-size: 0.85rem;
    }

    .result-question {
      color: #aaa;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* ë¶„ì„ ê²°ê³¼ */
    .analysis-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }

    .analysis-section h3 {
      font-size: 1.1rem;
      color: #10B981;
      margin-bottom: 1rem;
    }

    .transcript-box {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 1rem;
      line-height: 1.8;
      color: #ccc;
    }

    .feedback-box {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid #10B981;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      line-height: 1.8;
    }

    /* ì•Œë¦¼ */
    .alert {
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      align-items: start;
      gap: 0.75rem;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #EF4444;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10B981;
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #F59E0B;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: #93C5FD;
    }

    /* ëª¨ë²” ìŒì„± ë”°ë¼í•˜ê¸° */
    .sample-audio-section {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .sample-audio-section h3 {
      color: #A78BFA;
      margin-bottom: 1rem;
    }

    /* í…Œì´ë¸” (ê´€ë¦¬ì) */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 1rem;
      text-align: left;
    }

    th {
      background: rgba(0, 0, 0, 0.3);
      color: #aaa;
      font-size: 0.9rem;
    }

    tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* ìƒíƒœ ë±ƒì§€ */
    .status-badge {
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-not-started {
      background: rgba(107, 114, 128, 0.2);
      color: #9CA3AF;
    }

    .status-in-progress {
      background: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
    }

    .status-completed {
      background: rgba(16, 185, 129, 0.2);
      color: #10B981;
    }

    /* ìˆ¨ê¹€ */
    .hidden {
      display: none !important;
    }

    /* ì´ë ¥ ë¹„êµ */
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }

    .comparison-card {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 1.25rem;
    }

    .comparison-card h4 {
      color: #10B981;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .comparison-card .attempt-num {
      background: rgba(16, 185, 129, 0.2);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .tab-btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      .timer-display {
        font-size: 3rem;
      }

      .record-btn {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
      }

      .question-item {
        grid-template-columns: 1fr;
      }
    }

    /* ì—°ìŠµê²°ê³¼ ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .attempt-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {
      .attempt-grid {
        grid-template-columns: 1fr;
      }
    }

    .attempt-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .attempt-card:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    .attempt-card.selected {
      border-color: #10B981;
      background: rgba(16, 185, 129, 0.15);
    }

    .attempt-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .attempt-card.locked:hover {
      transform: none;
    }

    .attempt-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #10B981;
      margin-bottom: 0.5rem;
    }

    .attempt-card.locked .attempt-number {
      color: #666;
    }

    .attempt-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.75rem;
    }

    .attempt-date {
      font-size: 0.9rem;
      color: #888;
    }

    .attempt-question {
      font-size: 0.85rem;
      color: #aaa;
      margin-top: 0.5rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ìƒì„¸ ê²°ê³¼ ì˜ì—­ */
    .detail-section {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      overflow: hidden;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .detail-header {
      background: rgba(16, 185, 129, 0.1);
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      flex-wrap: wrap;
      gap: 1rem;
    }

    .detail-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #10B981;
    }

    .detail-date {
      font-size: 0.85rem;
      color: #888;
    }

    .detail-content {
      padding: 1.5rem;
    }

    .detail-block {
      margin-bottom: 1.5rem;
    }

    .detail-block:last-child {
      margin-bottom: 0;
    }

    .detail-block-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .detail-block-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .icon-question {
      background: rgba(59, 130, 246, 0.2);
    }

    .icon-answer {
      background: rgba(16, 185, 129, 0.2);
    }

    .icon-feedback {
      background: rgba(245, 158, 11, 0.2);
    }

    .detail-block-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #ccc;
    }

    .warning-inline {
      font-size: 0.75rem;
      color: #F59E0B;
      margin-left: auto;
    }

    .info-inline {
      font-size: 0.75rem;
      color: #F59E0B;
      margin-left: auto;
    }

    @media (max-width: 768px) {

      .warning-inline,
      .info-inline {
        display: block;
        margin-left: 0;
        margin-top: 0.5rem;
        width: 100%;
      }
    }

    .detail-block-content {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      line-height: 1.8;
      color: #ddd;
    }

    /* í”¼ë“œë°± ëŒ€ì‹œë³´ë“œ */
    .feedback-dashboard {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 0.75rem;
    }

    @media (max-width: 768px) {
      .feedback-dashboard {
        grid-template-columns: 1fr;
      }
    }

    .feedback-card {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .feedback-card.full-width {
      grid-column: 1 / -1;
    }

    .feedback-card-header {
      padding: 0.875rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .card-relevance .feedback-card-header {
      background: rgba(59, 130, 246, 0.15);
      color: #93C5FD;
    }

    .card-strength .feedback-card-header {
      background: rgba(16, 185, 129, 0.15);
      color: #6EE7B7;
    }

    .card-improve .feedback-card-header {
      background: rgba(245, 158, 11, 0.15);
      color: #FCD34D;
    }

    .card-suggestion .feedback-card-header {
      background: rgba(139, 92, 246, 0.15);
      color: #C4B5FD;
    }

    .feedback-card-content {
      padding: 1rem;
      line-height: 1.7;
      color: #ddd;
      font-size: 0.9rem;
    }

    .feedback-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .feedback-list li {
      padding: 0.5rem 0;
      padding-left: 1.5rem;
      position: relative;
    }

    .feedback-list li:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .list-positive li::before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #10B981;
      font-weight: bold;
    }

    .list-warning li::before {
      content: "â—";
      position: absolute;
      left: 0;
      color: #F59E0B;
      font-size: 0.6rem;
      top: 0.75rem;
    }

    .suggestion-box {
      background: rgba(139, 92, 246, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 3px solid #8B5CF6;
    }

    .suggestion-label {
      font-weight: 600;
      color: #C4B5FD;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .suggestion-text {
      color: #e8e8e8;
      line-height: 1.8;
      font-style: italic;
    }

    .checklist-box {
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .checklist-label {
      font-weight: 600;
      color: #93C5FD;
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
    }

    .checklist {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .checklist li {
      padding: 0.4rem 0;
      padding-left: 1.75rem;
      position: relative;
      color: #ccc;
    }

    .checklist li::before {
      content: "â˜";
      position: absolute;
      left: 0;
      color: #3B82F6;
    }

    .final-message {
      text-align: center;
      padding: 1rem;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 8px;
      color: #6EE7B7;
    }

    .final-message strong {
      color: #10B981;
    }

    /* ìŒì„± ë¶„ì„ ê²°ê³¼ ìŠ¤íƒ€ì¼ */
    .voice-analysis-section {
      background: rgba(139, 92, 246, 0.08);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .voice-analysis-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .voice-analysis-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #C4B5FD;
      margin: 0;
    }

    .voice-analysis-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .voice-analysis-grid {
        grid-template-columns: 1fr;
      }
    }

    .voice-metric {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      padding: 1rem;
    }

    .voice-metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .voice-metric-label {
      font-size: 0.9rem;
      color: #e8e8e8;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .voice-metric-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
    }

    .voice-meter {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .voice-meter-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .voice-meter-fill.excellent {
      background: linear-gradient(90deg, #10B981, #34D399);
    }

    .voice-meter-fill.good {
      background: linear-gradient(90deg, #3B82F6, #60A5FA);
    }

    .voice-meter-fill.warning {
      background: linear-gradient(90deg, #F59E0B, #FBBF24);
    }

    .voice-meter-fill.low {
      background: linear-gradient(90deg, #EF4444, #F87171);
    }

    .voice-metric-desc {
      font-size: 0.85rem;
      color: #ccc;
      margin-top: 0.5rem;
    }

    .voice-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .voice-status-badge.excellent {
      background: rgba(16, 185, 129, 0.2);
      color: #6EE7B7;
    }

    .voice-status-badge.good {
      background: rgba(59, 130, 246, 0.2);
      color: #93C5FD;
    }

    .voice-status-badge.warning {
      background: rgba(245, 158, 11, 0.2);
      color: #FCD34D;
    }

    .voice-status-badge.low {
      background: rgba(239, 68, 68, 0.2);
      color: #FCA5A5;
    }

    /* í™•ì¥ëœ ìŒì„± ë¶„ì„ ìŠ¤íƒ€ì¼ */
    .voice-analysis-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 0.75rem;
    }

    .voice-tab-btn {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: #888;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .voice-tab-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #ccc;
    }

    .voice-tab-btn.active {
      background: rgba(139, 92, 246, 0.2);
      color: #C4B5FD;
    }

    .voice-tab-content {
      display: none;
    }

    .voice-tab-content.active {
      display: block;
    }

    /* í•„ëŸ¬ ì›Œë“œ ìŠ¤íƒ€ì¼ */
    .filler-word-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .filler-word-tag {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #FCA5A5;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .filler-word-tag .count {
      background: rgba(239, 68, 68, 0.3);
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      margin-left: 0.35rem;
      font-weight: 600;
    }

    /* íŠ¸ë Œë“œ ì‹œê°í™” */
    .trend-chart {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      height: 80px;
      padding: 0.5rem 0;
    }

    .trend-bar-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .trend-bar {
      width: 100%;
      border-radius: 6px 6px 0 0;
      transition: height 0.5s ease;
    }

    .trend-bar.early {
      background: linear-gradient(180deg, #60A5FA, #3B82F6);
    }

    .trend-bar.middle {
      background: linear-gradient(180deg, #34D399, #10B981);
    }

    .trend-bar.late {
      background: linear-gradient(180deg, #FBBF24, #F59E0B);
    }

    .trend-label {
      font-size: 0.75rem;
      color: #888;
    }

    .trend-value {
      font-size: 0.8rem;
      font-weight: 600;
      color: #ccc;
    }

    /* ê¸´ ì¹¨ë¬µ ì¹´ë“œ */
    .silence-card {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      margin-top: 0.5rem;
    }

    .silence-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .silence-time {
      font-size: 0.9rem;
      color: #FCD34D;
      font-weight: 500;
    }

    .silence-duration {
      font-size: 0.85rem;
      color: #ccc;
    }

    /* WPM ê°€ì´ë“œ ë°•ìŠ¤ */
    .wpm-guide-box {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid #3B82F6;
      padding: 0.75rem 1rem;
      border-radius: 0 8px 8px 0;
      margin-top: 0.75rem;
    }

    .wpm-guide-box.ideal {
      background: rgba(16, 185, 129, 0.1);
      border-left-color: #10B981;
    }

    .wpm-guide-box.slow {
      background: rgba(245, 158, 11, 0.1);
      border-left-color: #F59E0B;
    }

    .wpm-guide-box.fast {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: #EF4444;
    }

    .wpm-guide-text {
      font-size: 0.95rem;
      color: #fff;
      line-height: 1.5;
    }

    /* ì—ë„ˆì§€ ë ˆë²¨ ë¯¸í„° */
    .energy-meter {
      display: flex;
      gap: 3px;
      margin: 0.75rem 0;
    }

    .energy-bar {
      flex: 1;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      transition: all 0.3s;
    }

    .energy-bar.filled.low {
      background: linear-gradient(180deg, #60A5FA, #3B82F6);
    }

    .energy-bar.filled.mid {
      background: linear-gradient(180deg, #34D399, #10B981);
    }

    .energy-bar.filled.high {
      background: linear-gradient(180deg, #FBBF24, #F59E0B);
    }

    .energy-bar.filled.max {
      background: linear-gradient(180deg, #F87171, #EF4444);
    }

    /* ë©”íŠ¸ë¦­ ì¹´ë“œ í’€ì™€ì´ë“œ */
    .voice-metric.full-width {
      grid-column: 1 / -1;
    }

    /* ë¶„ì„ ìš”ì•½ ì¹´ë“œ */
    .analysis-summary {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.1));
      border: 1px solid rgba(139, 92, 246, 0.25);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
    }

    .summary-title {
      font-size: 0.9rem;
      color: #C4B5FD;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .summary-text {
      font-size: 0.95rem;
      color: #e8e8e8;
      line-height: 1.6;
    }

    .summary-highlight {
      color: #FCD34D;
      font-weight: 500;
    }

    /* ==================== ì˜ìƒ ë¶„ì„ ê´€ë ¨ ìŠ¤íƒ€ì¼ ==================== */

    /* ëª¨ë“œ ì„ íƒ UI */
    .mode-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      justify-content: center;
    }

    .mode-option {
      flex: 1;
      max-width: 280px;
      padding: 1.25rem;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .mode-option:hover {
      border-color: rgba(16, 185, 129, 0.5);
      background: rgba(0, 0, 0, 0.4);
    }

    .mode-option.selected {
      border-color: #10B981;
      background: rgba(16, 185, 129, 0.1);
    }

    .mode-option .mode-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }

    .mode-option .mode-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e8e8e8;
      margin-bottom: 0.5rem;
    }

    .mode-option .mode-desc {
      font-size: 0.85rem;
      color: #888;
      line-height: 1.4;
    }

    .mode-option.selected .mode-title {
      color: #10B981;
    }

    .mode-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: rgba(59, 130, 246, 0.2);
      color: #60A5FA;
      border-radius: 8px;
      font-size: 0.7rem;
      margin-top: 0.5rem;
    }

    /* ë¹„ë””ì˜¤ í”„ë¦¬ë·° ì˜ì—­ */
    .video-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto 1.5rem;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
    }

    .video-preview {
      width: 100%;
      height: auto;
      display: block;
      transform: scaleX(-1);
    }

    .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .video-canvas {
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
    }

    .video-status {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .video-status.recording {
      background: rgba(239, 68, 68, 0.8);
    }

    .video-status .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10B981;
    }

    .video-status.recording .status-dot {
      background: #fff;
      animation: blink 1s infinite;
    }

    .realtime-stats {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .stat-badge {
      padding: 0.4rem 0.75rem;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .stat-badge .stat-icon {
      font-size: 1rem;
    }

    .stat-badge .stat-value {
      font-weight: 600;
    }

    .stat-badge.good {
      border: 1px solid rgba(16, 185, 129, 0.5);
    }

    .stat-badge.warning {
      border: 1px solid rgba(245, 158, 11, 0.5);
    }

    .video-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #888;
    }

    .video-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: #10B981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ì˜ìƒ ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ */
    .video-analysis-section {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05));
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .video-analysis-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .video-analysis-header h3 {
      font-size: 1.15rem;
      font-weight: 600;
      color: #C4B5FD;
      margin: 0;
    }

    .video-analysis-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .video-analysis-grid {
        grid-template-columns: 1fr;
      }

      .mode-selector {
        flex-direction: column;
        align-items: center;
      }

      .mode-option {
        max-width: 100%;
      }
    }

    .video-metric {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .video-metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .video-metric-label {
      font-weight: 600;
      color: #ccc;
      font-size: 0.95rem;
    }

    .video-metric-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .video-metric-value.excellent {
      color: #10B981;
    }

    .video-metric-value.good {
      color: #60A5FA;
    }

    .video-metric-value.warning {
      color: #F59E0B;
    }

    .video-metric-value.poor {
      color: #EF4444;
    }

    .video-metric-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .video-metric-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .video-metric-fill.excellent {
      background: linear-gradient(90deg, #10B981, #34D399);
    }

    .video-metric-fill.good {
      background: linear-gradient(90deg, #3B82F6, #60A5FA);
    }

    .video-metric-fill.warning {
      background: linear-gradient(90deg, #F59E0B, #FCD34D);
    }

    .video-metric-fill.poor {
      background: linear-gradient(90deg, #EF4444, #FCA5A5);
    }

    .video-metric-desc {
      font-size: 0.85rem;
      color: #888;
      line-height: 1.4;
    }

    /* ê°ì • ë¶„í¬ ê·¸ë˜í”„ */
    .emotion-chart-container {
      grid-column: 1 / -1;
      padding: 1rem 0;
      text-align: center;
    }

    .emotion-bar-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .emotion-bar-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .emotion-label {
      width: 60px;
      font-size: 0.85rem;
      color: #aaa;
      text-align: right;
    }

    .emotion-bar {
      flex-grow: 1;
      height: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    .emotion-fill {
      height: 100%;
      border-radius: 6px;
      background: #C4B5FD;
      transition: width 0.5s ease;
    }

    .emotion-percent {
      width: 40px;
      font-size: 0.85rem;
      color: #C4B5FD;
      font-weight: 600;
    }

    /* ì˜ìƒ ë¶„ì„ ìš”ì•½ */
    .video-summary {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.05));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      grid-column: 1 / -1;
    }

    .video-summary-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: #10B981;
      margin-bottom: 0.75rem;
    }

    .video-summary-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .video-summary-item {
      padding: 0.4rem 0.75rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      font-size: 0.8rem;
      color: #ccc;
    }

    .video-summary-item.highlight {
      background: rgba(245, 158, 11, 0.2);
      color: #FCD34D;
      font-weight: 500;
    }
  </style>
</head>

<body>

  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <h2>ğŸ¯ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ</h2>
      <div class="input-group">
        <label>ë©´ì ‘ë²ˆí˜¸</label>
        <input type="text" id="loginId" placeholder="ì˜ˆ: A001" autocomplete="off">
      </div>
      <div class="input-group">
        <label>ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label>
        <input type="password" id="loginPw" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" autocomplete="off">
      </div>
      <button class="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
      <div id="loginError" class="login-error hidden"></div>
    </div>
  </div>

  <div id="mainScreen" class="container hidden">
    <header>
      <h1>ğŸ¯ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ ì‹œìŠ¤í…œ</h1>
      <p>ì§ˆë¬¸ ë“£ê¸° â†’ ë‹µë³€ ë…¹ìŒ â†’ AI í”¼ë“œë°± ë°›ê¸°</p>
      <div class="user-info">
        <span class="user-badge" id="userBadge">ë©´ì ‘ë²ˆí˜¸: -</span>
        <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <div class="tabs" id="mainTabs">
      <button class="tab-btn active" onclick="showTab('practice', event)">ğŸ¤ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ</button>
      <button class="tab-btn" onclick="showTab('results', event)">ğŸ“Š ì—°ìŠµ ê²°ê³¼</button>
      <button class="tab-btn" onclick="showTab('sample', event)">ğŸ§ ë”°ë¼í•˜ê¸° ì—°ìŠµ</button>
      <button class="tab-btn" id="settingsTabBtn" onclick="showTab('settings', event)">ğŸ“ ì§ˆë¬¸ ë°”ê¾¸ê¸°</button>
      <button class="tab-btn hidden" id="adminTabBtn" onclick="showTab('admin', event)">ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì</button>
    </div>

    <div id="practice" class="tab-content active">
      <div class="card">
        <div class="progress-container">
          <div class="progress-header">
            <span class="progress-title">ì—°ìŠµ ì§„í–‰ë¥ </span>
            <span class="progress-count" id="progressCount">0 / 3 íšŒ</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div class="progress-labels">
            <span class="progress-label" id="prog1">1íšŒì°¨</span>
            <span class="progress-label" id="prog2">2íšŒì°¨</span>
            <span class="progress-label" id="prog3">3íšŒì°¨</span>
          </div>
        </div>

        <div id="limitAlert" class="alert alert-warning hidden">
          <span>âš ï¸</span>
          <span>ì—°ìŠµ ê¸°íšŒ 3íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ íƒ­ì—ì„œ ë¶„ì„ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.</span>
        </div>
        <!-- ëª¨ë“œ ì„ íƒ UI -->
        <div class="mode-selector" id="modeSelector">
          <div class="mode-option selected" onclick="selectMode('audio')" id="modeAudio">
            <div class="mode-icon">ğŸ¤</div>
            <div class="mode-title">ìŒì„±ë§Œ ë¶„ì„</div>
            <div class="mode-desc">ë§ˆì´í¬ë¡œ ë‹µë³€ì„ ë…¹ìŒí•˜ê³ <br>AI í”¼ë“œë°±ì„ ë°›ìŠµë‹ˆë‹¤</div>
          </div>
          <div class="mode-option" onclick="selectMode('video')" id="modeVideo">
            <div class="mode-icon">ğŸ¬</div>
            <div class="mode-title">ìŒì„± + ì˜ìƒ ë¶„ì„</div>
            <div class="mode-desc">ì¹´ë©”ë¼ë¡œ í‘œì •, ì‹œì„ , ìì„¸ê¹Œì§€<br>ì¢…í•© ë¶„ì„í•©ë‹ˆë‹¤</div>
            <div class="mode-badge">NEW</div>
          </div>
        </div>
        <div class="recording-area" id="recordingArea">
          <div class="question-display">
            <div class="question-label">ì§ˆë¬¸</div>
            <div class="question-text" id="questionText">ìš°ë¦¬ ê¸°ê´€ì— ì§€ì›í•œ ë™ê¸°ë¥¼ ì†Œê°œí•´ì£¼ì„¸ìš”.</div>
          </div>
          <!-- ë¹„ë””ì˜¤ í”„ë¦¬ë·° ì˜ì—­ -->
          <div class="video-container hidden" id="videoContainer">
            <video class="video-preview" id="videoPreview" autoplay muted playsinline></video>
            <div class="video-overlay">
              <canvas class="video-canvas" id="videoCanvas"></canvas>
            </div>
            <div class="video-status" id="videoStatus">
              <span class="status-dot"></span>
              <span id="videoStatusText">ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</span>
            </div>
            <div class="realtime-stats" id="realtimeStats"></div>
            <div class="video-loading hidden" id="videoLoading">
              <div class="spinner"></div>
              <div>AI ëª¨ë¸ ë¡œë”© ì¤‘...</div>
            </div>
          </div>
          <div class="timer-display" id="timerDisplay">01:00</div>

          <div class="waveform-container">
            <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
            <div class="waveform-overlay" id="waveformOverlay">ğŸ¤ ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
          </div>

          <div class="recording-status hidden" id="recordingStatus">
            <span class="recording-dot"></span>
            <span>ë…¹ìŒ ì¤‘...</span>
          </div>

          <div>
            <button class="record-btn start" id="recordBtn" onclick="toggleRecording()">ğŸ¤</button>
          </div>
          <p style="color: #888; margin-top: 1rem;">ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 1ë¶„ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë©ë‹ˆë‹¤</p>
          <p style="color: #F59E0B; font-size: 0.85rem; margin-top: 0.5rem;">âš ï¸ ìµœì ì˜ ê²°ê³¼ë¥¼ ìœ„í•´, ë…¹ìŒì€ 10ì´ˆ ì´ìƒìœ¼ë¡œ í•˜ê³  ì†ŒìŒì´ ì ì€ ê³³ì—ì„œ
            ì§„í–‰í•´ì£¼ì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¶„ì„ì´ ë¶€ì •í™•í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

          <div class="audio-player hidden" id="audioPlayer">
            <p style="margin-bottom: 0.5rem; color: #10B981;">âœ… ë…¹ìŒ ì™„ë£Œ</p>
            <audio id="audioPlayback" controls></audio>
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
              <button class="btn btn-secondary" onclick="resetRecording()">ğŸ”„ ë‹¤ì‹œ ë…¹ìŒ</button>
              <button class="btn btn-primary" onclick="submitRecording()" id="submitBtn">ğŸ“¤ ë¶„ì„ ìš”ì²­</button>
            </div>
          </div>
        </div>

        <div class="hidden" id="analyzingArea" style="text-align: center; padding: 3rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”„</div>
          <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">AIê°€ ë‹µë³€ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
          <p style="color: #888;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ì•½ 10~20ì´ˆ)</p>
        </div>
      </div>
    </div>

    <div id="results" class="tab-content">
      <div class="card">
        <h2>ğŸ“Š ì—°ìŠµ ê²°ê³¼</h2>
        <p class="help-text" style="color: #888; font-size: 0.9rem; margin-bottom: 1.5rem;">ğŸ’¡ ê²°ê³¼ê°€ ê¶ê¸ˆí•œ íšŒì°¨ë¥¼ í´ë¦­í•´ ë³´ì„¸ìš”!</p>

        <!-- íšŒì°¨ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
        <div class="attempt-grid" id="attemptGrid">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>

        <div id="noResults" style="text-align: center; padding: 3rem; color: #666;">
          ğŸ“ ì•„ì§ ì—°ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëª¨ì˜ì—°ìŠµì„ ì§„í–‰í•´ì£¼ì„¸ìš”.
        </div>
      </div>

      <!-- ìƒì„¸ ê²°ê³¼ ì˜ì—­ -->
      <div class="detail-section hidden" id="resultDetail">
        <div class="detail-header">
          <div>
            <div class="detail-title" id="detailTitle">1íšŒì°¨ ë¶„ì„ ê²°ê³¼</div>
            <div class="detail-date" id="detailDate"></div>
          </div>
          <button class="btn btn-primary" onclick="downloadPDF()">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div class="detail-content">
          <!-- ìŒì„± ë¶„ì„ ê²°ê³¼ (ìƒˆë¡œ ì¶”ê°€) -->
          <div class="voice-analysis-section hidden" id="voiceAnalysisSection">
            <div class="voice-analysis-header">
              <span style="font-size: 1.5rem;">ğŸ“Š</span>
              <h3>ìŒì„± ë¶„ì„ ê²°ê³¼</h3>
            </div>
            <div class="voice-analysis-grid" id="voiceAnalysisGrid">
              <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
          </div>

          <!-- ì˜ìƒ ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
          <div class="video-analysis-section hidden" id="videoAnalysisSection">
            <div class="video-analysis-header">
              <span style="font-size: 1.5rem;">ğŸ¬</span>
              <h3>ì˜ìƒ ë¶„ì„ ê²°ê³¼</h3>
            </div>
            <div class="video-analysis-grid" id="videoAnalysisGrid"></div>
          </div>

          <!-- ì§ˆë¬¸ -->
          <div class="detail-block">
            <div class="detail-block-header">
              <div class="detail-block-icon icon-question">ğŸ“‹</div>
              <div class="detail-block-title">ì§ˆë¬¸</div>
            </div>
            <div class="detail-block-content" id="detailQuestion"></div>
          </div>

          <!-- ë‚˜ì˜ ë‹µë³€ -->
          <div class="detail-block">
            <div class="detail-block-header">
              <div class="detail-block-icon icon-answer">ğŸ¤</div>
              <div class="detail-block-title">ë‚˜ì˜ ë‹µë³€ (ìŒì„±â†’í…ìŠ¤íŠ¸)</div>
              <span class="warning-inline">âš ï¸ ë…¹ìŒ ìŒì„±ì„ AIê°€ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•œ ê²°ê³¼ë¡œ, ì£¼ë³€ í™˜ê²½(ì†ŒìŒ, ì—ì½” ë“±)ì— ë”°ë¼ ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
            </div>
            <div class="detail-block-content" id="detailTranscript"></div>
          </div>

          <!-- AI í”¼ë“œë°± -->
          <div class="detail-block">
            <div class="detail-block-header">
              <div class="detail-block-icon icon-feedback">ğŸ’¡</div>
              <div class="detail-block-title">AI í”¼ë“œë°±</div>
              <span class="info-inline">â„¹ï¸ ë³¸ AIë¶„ì„ì€ ìŒì„± ë³€í™˜ê³¼ AI ì²˜ë¦¬ì— ê¸°ë°˜í•˜ë¯€ë¡œ, ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì°¸ê³  ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</span>
            </div>
            <div class="feedback-dashboard" id="detailFeedback">
              <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="sample" class="tab-content">
      <div class="card">
        <h2>ğŸ§ ë”°ë¼í•˜ê¸° ì—°ìŠµ</h2>
        <p style="color: #888; margin-bottom: 1.5rem;">ì—°ìŠµ ìŒì„±ì„ ë“£ê³  ë”°ë¼ ë§í•´ë³´ì„¸ìš”. ë¶„ì„ ì—†ì´ ììœ ë¡­ê²Œ ì—°ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="sample-audio-section">
          <h3>ğŸ“¢ ì—°ìŠµ ìŒì„±</h3>
          <div id="sampleAudioList">
            <p style="color: #888; text-align: center; padding: 2rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>

        <div class="card" style="background: rgba(16,185,129,0.05);">
          <h3 style="color: #10B981; margin-bottom: 1rem;">ğŸ¤ ë”°ë¼í•˜ê¸° ë…¹ìŒ</h3>
          <div class="waveform-container">
            <canvas class="waveform-canvas" id="sampleWaveform"></canvas>
            <div class="waveform-overlay" id="sampleWaveformOverlay">ğŸ¤ ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
          </div>
          <div style="text-align: center; margin-top: 1rem;">
            <button class="record-btn start" id="sampleRecordBtn" onclick="toggleSampleRecording()">ğŸ¤</button>
          </div>
          <div class="audio-player hidden" id="samplePlayerResult">
            <p style="margin-bottom: 0.5rem; color: #10B981;">âœ… ë…¹ìŒ ì™„ë£Œ - ì¬ìƒí•´ì„œ í™•ì¸í•´ë³´ì„¸ìš”</p>
            <audio id="sampleAudioPlayback" controls style="width: 100%;"></audio>
            <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="resetSampleRecording()">ğŸ”„ ë‹¤ì‹œ
              ë…¹ìŒ</button>
          </div>
        </div>
      </div>
    </div>

    <div id="settings" class="tab-content">
      <div class="card">
        <h2>ğŸ“‹ ë©´ì ‘ ì§ˆë¬¸ ì„ íƒ</h2>
        <p style="color: #888; margin-bottom: 1.5rem;">ì—°ìŠµí•  ì§ˆë¬¸ì„ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•œ ì§ˆë¬¸ì´ ë©´ì ‘ ëª¨ì˜ì—°ìŠµì— ì ìš©ë©ë‹ˆë‹¤.</p>

        <div id="questionSelectList"></div>

        <div class="card"
          style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); background: transparent; border: none; padding-left: 0; padding-right: 0;">
          <h3 style="margin-bottom: 1rem;">ğŸ“ ë‚´ê°€ ì„¤ì •í•  ì§ˆë¬¸ (ìµœëŒ€ 5ê°œ)</h3>
          <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">ë‚˜ë§Œì˜ ì§ˆë¬¸ì„ ë§Œë“¤ê±°ë‚˜ ìˆ˜ì •í•˜ì—¬ ì—°ìŠµì— í™œìš©í•˜ì„¸ìš”. <span
              style="font-weight: bold; color: #ffeb3b;">ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë©´ì ‘ ì—°ìŠµ ì§ˆë¬¸ ëª©ë¡ì— ë°˜ì˜ë©ë‹ˆë‹¤.</span></p>
          <div id="userQuestionList"></div>
          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="addUserQuestion()" id="addUserQuestionBtn">â• ì§ˆë¬¸ ì¶”ê°€</button>
            <button class="btn btn-primary" onclick="saveUserQuestions()">ğŸ’¾ ë‚´ ì§ˆë¬¸ ì €ì¥</button>
          </div>
        </div>

        <div id="adminQuestionSection" class="hidden"
          style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
          <h3 style="margin-bottom: 1rem;">ğŸ‘¨â€ğŸ’¼ ì§ˆë¬¸ ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©)</h3>
          <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">ì—¬ê¸°ì„œ ìˆ˜ì •í•œ ì§ˆë¬¸ì€ ëª¨ë“  ì§€ì›ìì˜ ê¸°ë³¸ ì§ˆë¬¸ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤. (ìµœëŒ€ 5ê°œ)</p>
          <div id="questionList"></div>
          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="addQuestion()" id="addQuestionBtn">â• ì§ˆë¬¸ ì¶”ê°€</button>
            <button class="btn btn-primary" onclick="saveQuestions()">ğŸ’¾ ê¸°ë³¸ ì§ˆë¬¸ ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>

    <div id="admin" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>ğŸ‘¨â€ğŸ’¼ ì§€ì›ì í˜„í™©</h2>
          <button class="btn btn-secondary" onclick="refreshAdmin()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>ë©´ì ‘ë²ˆí˜¸</th>
                <th>ì—°ìŠµ íšŸìˆ˜</th>
                <th>ìƒíƒœ</th>
                <th>ë§ˆì§€ë§‰ ì—°ìŠµ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="adminTable">
              <tr>
                <td colspan="5" style="text-align: center; padding: 2rem; color: #666;">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ§ ì—°ìŠµ ìŒì„± ê´€ë¦¬</h2>
        <p style="color: #888; margin-bottom: 1rem;">ì§€ì›ìê°€ ë”°ë¼í•  ì—°ìŠµ ìŒì„± íŒŒì¼ì„ ë“±ë¡í•©ë‹ˆë‹¤.</p>

        <div id="sampleAudioManage">
          <div class="alert alert-info" style="margin-bottom: 1rem;">
            <span>ğŸ’¡</span>
            <span>Google Drive: íŒŒì¼ ìš°í´ë¦­ â†’ ê³µìœ  â†’ ë§í¬ ë³µì‚¬ í›„, <code>drive.google.com/file/d/íŒŒì¼ID/view</code>ì—ì„œ íŒŒì¼IDë¥¼ ë³µì‚¬í•˜ì—¬
              <code>drive.google.com/uc?export=download&id=íŒŒì¼ID</code> í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.</span>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label>ìŒì„± ì œëª©</label>
            <input type="text" id="sampleAudioTitle" placeholder="ì˜ˆ: ì§€ì›ë™ê¸° ëª¨ë²”ë‹µë³€">
          </div>
          <div style="margin-bottom: 1.5rem;">
            <label>ìŒì„± íŒŒì¼ URL</label>
            <input type="text" id="sampleAudioUrl" placeholder="https://drive.google.com/uc?export=download&id=íŒŒì¼ID">
            <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">â€» Google Drive ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ ë˜ëŠ” mp3/wav ì§ì ‘ ë§í¬
            </p>
          </div>
          <div style="margin-bottom: 1.5rem;">
            <label>ìŠ¤í¬ë¦½íŠ¸ (ëŒ€ë³¸)</label>
            <textarea id="sampleAudioScript" rows="4" placeholder="ì§€ì›ìê°€ ë”°ë¼ ì½ì„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          </div>
          <button class="btn btn-primary" onclick="addSampleAudio()">â• ì—°ìŠµ ìŒì„± ì¶”ê°€</button>

          <div style="margin-top: 2rem;">
            <h3 style="font-size: 1rem; margin-bottom: 1rem;">ğŸ“‚ ë“±ë¡ëœ ì—°ìŠµ ìŒì„±</h3>
            <div id="adminSampleAudioList">
              <p style="color: #666; text-align: center; padding: 1rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“Š í†µê³„</h2>
        <div
          style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
          <div style="background: rgba(16,185,129,0.1); padding: 1.5rem; border-radius: 12px; text-align: center;">
            <div style="font-size: 2.5rem; font-weight: 700; color: #10B981;" id="statTotal">0</div>
            <div style="color: #888;">ì „ì²´ ì§€ì›ì</div>
          </div>
          <div style="background: rgba(245,158,11,0.1); padding: 1.5rem; border-radius: 12px; text-align: center;">
            <div style="font-size: 2.5rem; font-weight: 700; color: #F59E0B;" id="statInProgress">0</div>
            <div style="color: #888;">ì§„í–‰ ì¤‘</div>
          </div>
          <div style="background: rgba(59,130,246,0.1); padding: 1.5rem; border-radius: 12px; text-align: center;">
            <div style="font-size: 2.5rem; font-weight: 700; color: #3B82F6;" id="statCompleted">0</div>
            <div style="color: #888;">ì™„ë£Œ (3íšŒ)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>


    // ==================== ìƒíƒœ ê´€ë¦¬ ====================
    let currentUser = null;
    let isAdmin = false;
    let questions = [
      { id: 1, text: 'ìš°ë¦¬ ê¸°ê´€ì— ì§€ì›í•œ ë™ê¸°ë¥¼ ì†Œê°œí•´ì£¼ì„¸ìš”.' }
    ];
    let savedUserQuestions = []; // <--- ì„œë²„ì— ì €ì¥ëœ ìµœì¢… ì§ˆë¬¸ ëª©ë¡ (ì¶”ê°€)
    let userQuestions = []; // <--- í˜„ì¬ 'ì§ˆë¬¸ ë°”ê¾¸ê¸°' íƒ­ì—ì„œ í¸ì§‘ ì¤‘ì¸ ì„ì‹œ ëª©ë¡ìœ¼ë¡œ ì—­í•  ë³€ê²½
    let selectedQuestionId = 1; // ì„ íƒëœ ì§ˆë¬¸ ID
    let practices = [];
    let sampleAudios = []; // ì—°ìŠµ ìŒì„± ëª©ë¡
    let mediaRecorder = null;
    let audioChunks = [];
    let audioBlob = null;
    let audioUrl = null;
    let isRecording = false;
    let timerInterval = null;
    let timeLeft = 60;
    let audioContext = null;
    let analyser = null;
    let animationId = null;

    // ë”°ë¼í•˜ê¸° ì—°ìŠµìš©
    let sampleMediaRecorder = null;
    let sampleAudioChunks = [];
    let sampleIsRecording = false;
    let sampleAudioContext = null;
    let sampleAnalyser = null;
    let sampleAnimationId = null;

    // ìŒì„± ë¶„ì„ìš© ë°ì´í„° (í™•ì¥)
    let voiceAnalysisData = {
      volumeSamples: [],           // ë³¼ë¥¨ ìƒ˜í”Œ (í‰ê·  ìŒëŸ‰ ê³„ì‚°ìš©)
      silenceTime: 0,              // ì¹¨ë¬µ ì‹œê°„ (ms)
      speakingTime: 0,             // ë§í•˜ê¸° ì‹œê°„ (ms)
      lastSampleTime: null,        // ë§ˆì§€ë§‰ ìƒ˜í”Œ ì‹œê°„
      silenceThreshold: 15,        // ì¹¨ë¬µ íŒë‹¨ ì„ê³„ê°’ (0-255)

      // ìƒˆë¡œìš´ ë¶„ì„ ë°ì´í„°
      longSilences: [],            // 2ì´ˆ ì´ìƒ ê¸´ ì¹¨ë¬µ ê¸°ë¡ [{startTime, duration}]
      currentSilenceStart: null,   // í˜„ì¬ ì¹¨ë¬µ ì‹œì‘ ì‹œê°„
      segmentVolumes: {            // êµ¬ê°„ë³„ ë³¼ë¥¨ (ì´ˆë°˜/ì¤‘ë°˜/í›„ë°˜)
        early: [],
        middle: [],
        late: []
      },
      recordingStartTime: null,    // ë…¹ìŒ ì‹œì‘ ì‹œê°„
      peakVolumes: [],             // í”¼í¬ ë³¼ë¥¨ ê¸°ë¡ (ì—ë„ˆì§€ ë ˆë²¨ìš©)
      volumeChanges: []            // ë³¼ë¥¨ ë³€í™”ëŸ‰ ê¸°ë¡ (í™œê¸° ì¸¡ì •ìš©)
    };

    // ==================== ì˜ìƒ ë¶„ì„ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ====================
    let analysisMode = 'audio';
    let videoStream = null;
    let videoRecorder = null;
    let videoChunks = [];
    let videoBlob = null;
    let faceApiLoaded = false;
    let faceDetectionInterval = null;

    let videoAnalysisData = {
      expressionSamples: [],
      gazeDirections: [],
      headPoses: [],
      cameraLookRatio: 0,
      dominantExpression: null,
      expressionDistribution: {},
      stabilityScore: 0,
      smileRatio: 0
    };

    // API ë² ì´ìŠ¤ URL (ê°œë°œ/í”„ë¡œë•ì…˜ ìë™ ê°ì§€)
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';

    // ==================== ì´ˆê¸°í™” ====================
    document.addEventListener('DOMContentLoaded', function () {
      // ì €ì¥ëœ ì„¸ì…˜ í™•ì¸
      const savedUser = sessionStorage.getItem('interviewUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainScreen();
      }

      // ì—”í„°í‚¤ ë¡œê·¸ì¸
      document.getElementById('loginPw').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') doLogin();
      });
      document.getElementById('loginId').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') document.getElementById('loginPw').focus();
      });
    });

    // face-api.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë“œ
    async function loadFaceApi() {
      if (faceApiLoaded) return true;

      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js';
        script.onload = async () => {
          try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
            await Promise.all([
              faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
              faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
              faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL)
            ]);
            faceApiLoaded = true;
            console.log('face-api.js ëª¨ë¸ ë¡œë“œ ì™„ë£Œ');
            resolve(true);
          } catch (err) {
            console.error('face-api.js ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:', err);
            reject(err);
          }
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function selectMode(mode) {
      analysisMode = mode;
      document.getElementById('modeAudio').classList.toggle('selected', mode === 'audio');
      document.getElementById('modeVideo').classList.toggle('selected', mode === 'video');

      const videoContainer = document.getElementById('videoContainer');
      if (mode === 'video') {
        videoContainer.classList.remove('hidden');
        initVideoPreview();
      } else {
        videoContainer.classList.add('hidden');
        stopVideoPreview();
      }
    }

    async function initVideoPreview() {
      const video = document.getElementById('videoPreview');
      const loading = document.getElementById('videoLoading');

      loading.classList.remove('hidden');

      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' },
          audio: false
        });

        video.srcObject = videoStream;
        await video.play();
        await loadFaceApi();

        loading.classList.add('hidden');
        document.getElementById('videoStatusText').textContent = 'ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ';

        const canvas = document.getElementById('videoCanvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        startRealtimeFaceDetection();
      } catch (err) {
        console.error('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
        loading.innerHTML = '<div style="padding:2rem;text-align:center;color:#888;">ğŸ“· ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br><small>ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</small></div>';
      }
    }

    function stopVideoPreview() {
      if (faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
        faceDetectionInterval = null;
      }
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
    }

    function startRealtimeFaceDetection() {
      const video = document.getElementById('videoPreview');
      const canvas = document.getElementById('videoCanvas');
      const ctx = canvas.getContext('2d');
      const statsContainer = document.getElementById('realtimeStats');

      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });

      faceDetectionInterval = setInterval(async () => {
        if (!video.srcObject) return;

        try {
          const detection = await faceapi
            .detectSingleFace(video, options)
            .withFaceLandmarks(true)
            .withFaceExpressions();

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          if (detection) {
            const box = detection.detection.box;
            ctx.strokeStyle = '#10B981';
            ctx.lineWidth = 2;
            ctx.strokeRect(box.x, box.y, box.width, box.height);

            const expressions = detection.expressions;
            const sorted = Object.entries(expressions).sort((a, b) => b[1] - a[1]);
            const dominant = sorted[0];
            const gazeDirection = estimateGazeDirection(detection.landmarks);

            statsContainer.innerHTML = `
          <div class="stat-badge ${dominant[1] > 0.5 ? 'good' : ''}">
            <span class="stat-icon">${getExpressionEmoji(dominant[0])}</span>
            <span class="stat-value">${translateExpression(dominant[0])}</span>
          </div>
          <div class="stat-badge ${gazeDirection === 'center' ? 'good' : 'warning'}">
            <span class="stat-icon">ğŸ‘ï¸</span>
            <span class="stat-value">${translateGaze(gazeDirection)}</span>
          </div>
        `;

            if (isRecording && analysisMode === 'video') {
              collectVideoAnalysisData(detection, gazeDirection);
            }
          } else {
            statsContainer.innerHTML = '<div class="stat-badge warning"><span class="stat-icon">âš ï¸</span><span class="stat-value">ì–¼êµ´ ê°ì§€ ì•ˆë¨</span></div>';
          }
        } catch (err) {
          console.error('ì–¼êµ´ ê°ì§€ ì˜¤ë¥˜:', err);
        }
      }, 200);
    }

    function estimateGazeDirection(landmarks) {
      if (!landmarks) return 'unknown';
      const positions = landmarks.positions;
      const noseTip = positions[30];
      const leftEye = landmarks.getLeftEye();
      const rightEye = landmarks.getRightEye();

      const leftEyeCenter = { x: leftEye.reduce((s, p) => s + p.x, 0) / leftEye.length, y: leftEye.reduce((s, p) => s + p.y, 0) / leftEye.length };
      const rightEyeCenter = { x: rightEye.reduce((s, p) => s + p.x, 0) / rightEye.length, y: rightEye.reduce((s, p) => s + p.y, 0) / rightEye.length };

      const faceCenterX = (leftEyeCenter.x + rightEyeCenter.x) / 2;
      const horizontalOffset = noseTip.x - faceCenterX;
      const eyeDistance = Math.abs(rightEyeCenter.x - leftEyeCenter.x);
      const normalizedOffset = horizontalOffset / eyeDistance;

      if (Math.abs(normalizedOffset) < 0.15) return 'center';
      return normalizedOffset > 0 ? 'right' : 'left';
    }

    function collectVideoAnalysisData(detection, gazeDirection) {
      if (!detection) return;
      videoAnalysisData.expressionSamples.push({ timestamp: Date.now(), expressions: { ...detection.expressions } });
      videoAnalysisData.gazeDirections.push(gazeDirection);

      const positions = detection.landmarks.positions;
      const leftEye = positions[36], rightEye = positions[45];
      const eyeSlope = (rightEye.y - leftEye.y) / (rightEye.x - leftEye.x);
      const roll = Math.atan(eyeSlope) * (180 / Math.PI);
      videoAnalysisData.headPoses.push({ roll });
    }

    function getExpressionEmoji(exp) {
      return { neutral: 'ğŸ˜', happy: 'ğŸ˜Š', sad: 'ğŸ˜¢', angry: 'ğŸ˜ ', fearful: 'ğŸ˜¨', disgusted: 'ğŸ¤¢', surprised: 'ğŸ˜²' }[exp] || 'ğŸ™‚';
    }

    function translateExpression(exp) {
      if (!exp) return 'ê°ì§€ ì•ˆë¨';
      return { neutral: 'ì¤‘ë¦½', happy: 'ë¯¸ì†Œ', sad: 'ìŠ¬í””', angry: 'í™”ë‚¨', fearful: 'ë¶ˆì•ˆ', disgusted: 'ë¶ˆì¾Œ', surprised: 'ë†€ëŒ' }[exp] || exp;
    }

    function translateGaze(dir) {
      if (!dir) return 'ê°ì§€ ì•ˆë¨';
      return { center: 'ì •ë©´ ì‘ì‹œ', left: 'ì™¼ìª½', right: 'ì˜¤ë¥¸ìª½', unknown: 'ê°ì§€ ì•ˆë¨' }[dir] || dir;
    }

    function processVideoAnalysisData() {
      const data = videoAnalysisData;
      if (data.expressionSamples.length === 0) return;

      // ì¹´ë©”ë¼ ì‘ì‹œ ë¹„ìœ¨
      const centerCount = data.gazeDirections.filter(d => d === 'center').length;
      data.cameraLookRatio = Math.round((centerCount / data.gazeDirections.length) * 100);

      // í‘œì • ë¶„í¬
      const expressionTotals = { neutral: 0, happy: 0, sad: 0, angry: 0, fearful: 0, disgusted: 0, surprised: 0 };
      data.expressionSamples.forEach(sample => {
        Object.keys(expressionTotals).forEach(exp => {
          expressionTotals[exp] += sample.expressions[exp] || 0;
        });
      });

      const sampleCount = data.expressionSamples.length;
      Object.keys(expressionTotals).forEach(exp => {
        data.expressionDistribution[exp] = Math.round((expressionTotals[exp] / sampleCount) * 100);
      });

      // ì£¼ìš” í‘œì •
      const sorted = Object.entries(data.expressionDistribution).sort((a, b) => b[1] - a[1]);
      data.dominantExpression = sorted[0][0];
      data.smileRatio = data.expressionDistribution.happy || 0;

      // ìì„¸ ì•ˆì •ì„±
      if (data.headPoses.length > 1) {
        let totalChange = 0;
        for (let i = 1; i < data.headPoses.length; i++) {
          totalChange += Math.abs(data.headPoses[i].roll - data.headPoses[i - 1].roll);
        }
        const avgChange = totalChange / (data.headPoses.length - 1);
        data.stabilityScore = Math.max(0, Math.min(100, Math.round(100 - avgChange * 5)));
      } else {
        data.stabilityScore = 80;
      }
    }

    function renderVideoAnalysis(videoAnalysis) {
      const section = document.getElementById('videoAnalysisSection');
      const grid = document.getElementById('videoAnalysisGrid');

      if (!videoAnalysis) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');

      const getGazeStatus = (r) => r >= 70 ? { label: 'í›Œë¥­í•¨', class: 'excellent', icon: 'âœ“' } : r >= 50 ? { label: 'ì¢‹ìŒ', class: 'good', icon: 'â—‹' } : r >= 30 ? { label: 'ê°œì„  í•„ìš”', class: 'warning', icon: '!' } : { label: 'ë§ì€ ê°œì„  í•„ìš”', class: 'low', icon: 'âœ—' };
      const getSmileStatus = (r) => r >= 30 ? { label: 'ë°ì€ ì¸ìƒ', class: 'excellent', icon: 'âœ“' } : r >= 15 ? { label: 'ì ë‹¹í•¨', class: 'good', icon: 'â—‹' } : r >= 5 ? { label: 'ì¡°ê¸ˆ ê²½ì§', class: 'warning', icon: '!' } : { label: 'ê¸´ì¥ë¨', class: 'low', icon: 'âœ—' };
      const getStabilityStatus = (s) => s >= 80 ? { label: 'ì•ˆì •ì ', class: 'excellent', icon: 'âœ“' } : s >= 60 ? { label: 'ì–‘í˜¸', class: 'good', icon: 'â—‹' } : s >= 40 ? { label: 'ì›€ì§ì„ ë§ìŒ', class: 'warning', icon: '!' } : { label: 'ë¶ˆì•ˆì •', class: 'low', icon: 'âœ—' };

      const gazeStatus = getGazeStatus(videoAnalysis.cameraLookRatio);
      const smileStatus = getSmileStatus(videoAnalysis.smileRatio);
      const stabilityStatus = getStabilityStatus(videoAnalysis.stabilityScore);

      let summaryItems = [];
      if (videoAnalysis.cameraLookRatio >= 70) summaryItems.push({ text: 'ì¹´ë©”ë¼ ì‘ì‹œ í›Œë¥­', type: 'positive' });
      else if (videoAnalysis.cameraLookRatio < 50) summaryItems.push({ text: 'ì¹´ë©”ë¼ ì‘ì‹œ ë” ìì£¼', type: 'warning' });
      if (videoAnalysis.smileRatio >= 20) summaryItems.push({ text: 'ë°ì€ í‘œì • ìœ ì§€', type: 'positive' });
      else if (videoAnalysis.smileRatio < 10) summaryItems.push({ text: 'ê°€ë²¼ìš´ ë¯¸ì†Œ ê¶Œì¥', type: 'warning' });
      if (videoAnalysis.stabilityScore >= 70) summaryItems.push({ text: 'ì•ˆì •ëœ ìì„¸', type: 'positive' });
      else if (videoAnalysis.stabilityScore < 50) summaryItems.push({ text: 'ìì„¸ ì•ˆì • í•„ìš”', type: 'warning' });

      const expressionBars = Object.entries(videoAnalysis.expressionDistribution || {})
        .map(([exp, value]) => `<div class="expression-bar"><div class="expression-bar-fill" style="height:${Math.min(100, value)}%"></div><div class="expression-bar-value">${value}%</div><div class="expression-bar-label">${getExpressionEmoji(exp)}</div></div>`).join('');

      grid.innerHTML = `
    ${summaryItems.length > 0 ? `<div class="video-summary"><div class="video-summary-title"><span>ğŸ¬</span><span>ì˜ìƒ ë¶„ì„ í•œëˆˆì— ë³´ê¸°</span></div><div class="video-summary-items">${summaryItems.map(i => `<span class="video-summary-item ${i.type}">${i.text}</span>`).join('')}</div></div>` : ''}
    
    <div class="video-metric">
      <div class="video-metric-header"><span class="video-metric-label">ğŸ‘ï¸ ì¹´ë©”ë¼ ì‘ì‹œ</span><span class="voice-status-badge ${gazeStatus.class}">${gazeStatus.icon} ${gazeStatus.label}</span></div>
      <div class="video-metric-value ${gazeStatus.class}">${videoAnalysis.cameraLookRatio}%</div>
      <div class="video-metric-bar"><div class="video-metric-fill ${gazeStatus.class}" style="width:${videoAnalysis.cameraLookRatio}%"></div></div>
      <div class="video-metric-desc">í™”ìƒ ë©´ì ‘ì—ì„œëŠ” ì¹´ë©”ë¼ ë Œì¦ˆë¥¼ ì§ì ‘ ë°”ë¼ë´ì•¼ ë©´ì ‘ê´€ê³¼ ëˆˆì„ ë§ì¶”ëŠ” íš¨ê³¼ê°€ ìˆì–´ìš”.</div>
    </div>
    
    <div class="video-metric">
      <div class="video-metric-header"><span class="video-metric-label">ğŸ˜Š ë¯¸ì†Œ ë¹„ìœ¨</span><span class="voice-status-badge ${smileStatus.class}">${smileStatus.icon} ${smileStatus.label}</span></div>
      <div class="video-metric-value ${smileStatus.class}">${videoAnalysis.smileRatio}%</div>
      <div class="video-metric-bar"><div class="video-metric-fill ${smileStatus.class}" style="width:${Math.min(100, videoAnalysis.smileRatio * 2)}%"></div></div>
      <div class="video-metric-desc">í•µì‹¬ í¬ì¸íŠ¸ì—ì„œ ê°€ë²¼ìš´ ë¯¸ì†Œë¥¼ ì§€ìœ¼ë©´ í˜¸ê°ë„ê°€ ì˜¬ë¼ê°€ìš”.</div>
    </div>
    
    <div class="video-metric">
      <div class="video-metric-header"><span class="video-metric-label">ğŸ§ ìì„¸ ì•ˆì •ì„±</span><span class="voice-status-badge ${stabilityStatus.class}">${stabilityStatus.icon} ${stabilityStatus.label}</span></div>
      <div class="video-metric-value ${stabilityStatus.class}">${videoAnalysis.stabilityScore}%</div>
      <div class="video-metric-bar"><div class="video-metric-fill ${stabilityStatus.class}" style="width:${videoAnalysis.stabilityScore}%"></div></div>
      <div class="video-metric-desc">ìƒì²´ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ë©´ ìì‹ ê° ìˆëŠ” ì¸ìƒì„ ì¤„ ìˆ˜ ìˆì–´ìš”.</div>
    </div>
    
    <div class="video-metric">
      <div class="video-metric-header"><span class="video-metric-label">ğŸ˜ í‘œì • ë¶„í¬</span><span class="voice-status-badge good">${getExpressionEmoji(videoAnalysis.dominantExpression)} ì£¼ìš”: ${translateExpression(videoAnalysis.dominantExpression)}</span></div>
      <div class="expression-chart">${expressionBars}</div>
      <div class="video-metric-desc">ë…¹í™” ì¤‘ ê°ì§€ëœ í‘œì •ì˜ ë¶„í¬ì…ë‹ˆë‹¤. ë‹¤ì–‘í•œ í‘œì •ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•˜ë©´ ì¢‹ì•„ìš”.</div>
    </div>
  `;
    }

    // ==================== ì˜ìƒ ë¶„ì„ ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜ ====================

    // í‘œì • ë ˆì´ë¸” ë³€í™˜ í•¨ìˆ˜ (renderVideoAnalysisì—ì„œ ì‚¬ìš©ë˜ë¯€ë¡œ ë¨¼ì € ì •ì˜)
    function getExpressionLabel(key) {
      const labels = {
        'neutral': 'ë¬´í‘œì •', 'happy': 'ê¸°ì¨', 'sad': 'ìŠ¬í””', 'angry': 'í™”ë‚¨',
        'fearful': 'ë‘ë ¤ì›€', 'disgusted': 'í˜ì˜¤', 'surprised': 'ë†€ëŒ'
      };
      return labels[key] || key;
    }



    // ==================== ë¡œê·¸ì¸ ====================
    async function doLogin() {
      const id = document.getElementById('loginId').value.trim();
      const pw = document.getElementById('loginPw').value.trim();
      const errorEl = document.getElementById('loginError');

      if (!id || !pw) {
        errorEl.textContent = 'ë©´ì ‘ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch(API_BASE + '/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ interviewId: id, password: pw })
        });

        const data = await res.json();

        if (!res.ok) {
          errorEl.textContent = data.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          errorEl.classList.remove('hidden');
          return;
        }

        currentUser = { interviewId: id, isAdmin: data.isAdmin };
        isAdmin = data.isAdmin;
        sessionStorage.setItem('interviewUser', JSON.stringify(currentUser));

        showMainScreen();

      } catch (err) {
        errorEl.textContent = 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        errorEl.classList.remove('hidden');
        console.error(err);
      }
    }

    function doLogout() {
      currentUser = null;
      isAdmin = false;
      sessionStorage.removeItem('interviewUser');
      practices = [];
      userQuestions = []; // **ì¶”ê°€: ë¡œê·¸ì•„ì›ƒ ì‹œ ë³¸ì¸ ì§ˆë¬¸ ì´ˆê¸°í™”**

      // ê´€ë¦¬ì íƒ­ ìˆ¨ê¸°ê¸°
      document.getElementById('adminTabBtn').classList.add('hidden');

      // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
      document.getElementById('attemptGrid').innerHTML = '';
      document.getElementById('resultDetail').classList.add('hidden');
      document.getElementById('noResults').classList.remove('hidden');

      // ì§„í–‰ë¥  ì´ˆê¸°í™”
      document.getElementById('progressCount').textContent = '0 / 3 íšŒ';
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('limitAlert').classList.add('hidden');
      document.getElementById('recordBtn').disabled = false;

      // ë…¹ìŒ ì˜ì—­ ì´ˆê¸°í™”
      document.getElementById('recordingArea').classList.remove('hidden');
      document.getElementById('analyzingArea').classList.add('hidden');
      document.getElementById('audioPlayer').classList.add('hidden');
      document.getElementById('waveformOverlay').classList.remove('hidden');
      document.getElementById('recordingStatus').classList.add('hidden');
      document.getElementById('timerDisplay').textContent = '01:00';
      document.getElementById('timerDisplay').classList.remove('warning', 'danger');
      const recordBtn = document.getElementById('recordBtn');
      recordBtn.classList.remove('stop');
      recordBtn.classList.add('start');
      recordBtn.textContent = 'ğŸ¤';

      // ì²« ë²ˆì§¸ íƒ­ìœ¼ë¡œ ì´ë™
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.tab-btn').classList.add('active');
      document.getElementById('practice').classList.add('active');

      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainScreen').classList.add('hidden');
      document.getElementById('loginId').value = '';
      document.getElementById('loginPw').value = '';
      document.getElementById('loginError').classList.add('hidden');
    }

    function showMainScreen() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainScreen').classList.remove('hidden');
      document.getElementById('userBadge').textContent = 'ë©´ì ‘ë²ˆí˜¸: ' + currentUser.interviewId;

      // ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€
      if (currentUser.isAdmin) {
        document.getElementById('adminTabBtn').classList.remove('hidden');
        isAdmin = true;
      } else {
        document.getElementById('adminTabBtn').classList.add('hidden');
        isAdmin = false;
      }

      // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™” í›„ ìƒˆë¡œ ë¡œë“œ
      practices = [];

      loadQuestions();
      loadUserQuestions(); // **ì¶”ê°€: ì§€ì›ì ì§ˆë¬¸ ë¡œë“œ**
      loadPractices();
      loadSampleAudios();
    }

    // ==================== íƒ­ ì „í™˜ ====================
    function showTab(tabId, event) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      if (event && event.target) {
        event.target.classList.add('active');
      } else {
        // ë²„íŠ¼ ì§ì ‘ ì°¾ì•„ì„œ í™œì„±í™”
        document.querySelectorAll('.tab-btn').forEach(btn => {
          if (btn.textContent.includes(tabId === 'practice' ? 'ë©´ì ‘' :
            tabId === 'results' ? 'ê²°ê³¼' :
              tabId === 'sample' ? 'ë”°ë¼í•˜ê¸°' :
                tabId === 'settings' ? 'ì§ˆë¬¸' : 'ê´€ë¦¬ì')) {
            btn.classList.add('active');
          }
        });
      }
      document.getElementById(tabId).classList.add('active');

      if (tabId === 'admin' && isAdmin) {
        loadAdminData();
        renderAdminSampleAudios();
      }
      if (tabId === 'settings') {
        // **ìˆ˜ì •ëœ ë¶€ë¶„: settings íƒ­ ì§„ì… ì‹œ, í¸ì§‘ìš© userQuestionsë¥¼ ì„œë²„ ì €ì¥ë³¸ìœ¼ë¡œ ë”¥ ì¹´í”¼í•˜ì—¬ ì´ˆê¸°í™”**
        userQuestions = JSON.parse(JSON.stringify(savedUserQuestions)); // <--- â­ ì´ ì¤„ì´ ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        renderQuestionSelect();
        renderUserQuestions(); // **ì¶”ê°€: ë‚´ ì§ˆë¬¸ ë Œë”ë§**

        if (isAdmin) {
          document.getElementById('adminQuestionSection').classList.remove('hidden');
          renderQuestions();
        } else {
          document.getElementById('adminQuestionSection').classList.add('hidden');
        }
      }
      if (tabId === 'sample') {
        renderSampleAudios();
      }
    }

    // ==================== ì§ˆë¬¸ ê´€ë¦¬ (ê´€ë¦¬ì) ====================
    async function loadQuestions() {
      try {
        const res = await fetch(API_BASE + '/api/practice?action=getQuestions');
        if (res.ok) {
          const data = await res.json();
          if (data.questions && data.questions.length > 0) {
            questions = data.questions;
          }
        }
      } catch (err) {
        console.error('ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', err);
      }

      // í˜„ì¬ ì§ˆë¬¸ í‘œì‹œ (selectedQuestionIdëŠ” loadUserQuestionsì—ì„œ ìµœì¢… ê²°ì •ë¨)
      updateCurrentQuestion();
    }

    // ==================== ì§ˆë¬¸ ê´€ë¦¬ (ì§€ì›ì) ====================
    async function loadUserQuestions() {
      if (!currentUser) return;
      try {
        const res = await fetch(API_BASE + '/api/practice?action=getUserQuestions&interviewId=' + currentUser.interviewId);
        if (res.ok) {
          const data = await res.json();
          savedUserQuestions = data.userQuestions || []; // <--- ìˆ˜ì •: ì €ì¥ëœ ì§ˆë¬¸ ëª©ë¡ì— ë°˜ì˜
          // userQuestionsëŠ” showTabì—ì„œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
        }
      } catch (err) {
        console.error('ë‚´ ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', err);
      }

      // ì €ì¥ëœ ì„ íƒ ì§ˆë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° (ë³¸ì¸ë§Œ ì ìš©)
      const savedSelection = sessionStorage.getItem('selectedQuestion_' + currentUser?.interviewId);
      if (savedSelection) {
        selectedQuestionId = parseInt(savedSelection);
      } else {
        selectedQuestionId = questions[0]?.id || 1;
      }

      // í˜„ì¬ ì§ˆë¬¸ í‘œì‹œ
      updateCurrentQuestion();
    }

    function getAllQuestions() {
      // ê´€ë¦¬ì ì§ˆë¬¸ (id: 1, 2, 3...) + ë‚´ ì§ˆë¬¸ (id: 1001, 1002...)
      // ë‚´ ì§ˆë¬¸ idëŠ” 1000ë¶€í„° ì‹œì‘í•˜ëŠ” ì„ì‹œ IDë¥¼ ì‚¬ìš©í•˜ê³ , ì €ì¥í•  ë•Œ interviewIdë¥¼ í•¨ê»˜ ì €ì¥í•˜ì—¬ êµ¬ë¶„
      const maxAdminId = questions.reduce((max, q) => Math.max(max, q.id), 0);
      const userQWithId = userQuestions.map((q, i) => ({
        id: 1000 + i + 1, // ì„ì‹œ ID í• ë‹¹
        text: q.text,
        isUser: true
      }));
      return [...questions, ...userQWithId];
    }

    function updateCurrentQuestion() {
      const allQ = getAllQuestions();
      const selectedQ = allQ.find(q => q.id === selectedQuestionId);
      if (selectedQ) {
        document.getElementById('questionText').textContent = selectedQ.text;
      } else if (questions.length > 0) {
        selectedQuestionId = questions[0].id;
        document.getElementById('questionText').textContent = questions[0].text;
      }
    }

    function renderQuestionSelect() {
      const list = document.getElementById('questionSelectList');
      if (!list) return;

      const allQ = getAllQuestions();

      if (allQ.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:2rem;color:#666;">ğŸ“‹ ì„¤ì •ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = '';
      allQ.forEach((q, i) => {
        const isSelected = q.id === selectedQuestionId;
        const isUser = q.isUser;
        const qType = isUser ? ' (ë‚´ ì§ˆë¬¸)' : ' (ê¸°ë³¸ ì§ˆë¬¸)';

        html += `<div style="background: ${isSelected ? 'rgba(16,185,129,0.2)' : 'rgba(0,0,0,0.2)'}; border: 2px solid ${isSelected ? '#10B981' : 'transparent'}; border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s;" onclick="selectQuestion(${q.id})">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid ${isSelected ? '#10B981' : '#666'}; display: flex; align-items: center; justify-content: center;">
          ${isSelected ? '<div style="width: 12px; height: 12px; border-radius: 50%; background: #10B981;"></div>' : ''}
        </div>
        <div style="flex: 1;">
          <p style="font-weight: 500; color: ${isSelected ? '#10B981' : '#e8e8e8'};">${q.text} <span style="font-size:0.8rem; color:#666;">${qType}</span></p>
        </div>
      </div>
    </div>`;
      });
      list.innerHTML = html;
    }

    function selectQuestion(id) {
      selectedQuestionId = id;
      // ë³¸ì¸ë§Œ ì ìš©ë˜ë„ë¡ sessionStorageì— ì €ì¥
      sessionStorage.setItem('selectedQuestion_' + currentUser.interviewId, id);
      updateCurrentQuestion();
      renderQuestionSelect();
    }

    function renderQuestions() { // ê´€ë¦¬ì ì§ˆë¬¸ ë Œë”ë§
      const list = document.getElementById('questionList');
      if (!list) return;

      if (questions.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:2rem;color:#666;">ğŸ“‹ ì„¤ì •ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = '';
      questions.forEach((q, i) => {
        html += `<div class="question-item">
      <span class="question-num">${i + 1}</span>
      <div>
        <label>ì§ˆë¬¸ ë‚´ìš©</label>
        <textarea rows="2" onchange="updateQuestion(${q.id}, this.value)">${q.text}</textarea>
      </div>
      <button class="delete-btn" onclick="deleteQuestion(${q.id})">ğŸ—‘ï¸</button>
    </div>`;
      });
      list.innerHTML = html;

      // ìµœëŒ€ 5ê°œ ì œí•œ
      const addBtn = document.getElementById('addQuestionBtn');
      if (addBtn) {
        if (questions.length >= 5) {
          addBtn.disabled = true;
          addBtn.style.opacity = '0.5';
          addBtn.title = 'ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤';
        } else {
          addBtn.disabled = false;
          addBtn.style.opacity = '1';
          addBtn.title = '';
        }
      }
    }

    // index.html (ì•½ 590í–‰ ë¶€ê·¼ì— ì•„ë˜ ì½”ë“œ ë¸”ë¡ ì¶”ê°€)

    // ==================== ì‚¬ìš©ì ì§ˆë¬¸ ê´€ë¦¬ í•¨ìˆ˜ ====================

    // ì‚¬ìš©ì ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderUserQuestions() {
      const container = document.getElementById('userQuestionList');
      if (!container) return;

      container.innerHTML = '';

      if (userQuestions.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ì¶”ê°€í•˜ê³  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>';
        return;
      }

      userQuestions.forEach((q, index) => {
        const item = document.createElement('div');
        item.className = 'question-item';
        item.dataset.id = q.id;
        item.innerHTML = `
      <div class="question-num">${index + 1}</div>
      <textarea 
        rows="2" 
        data-id="${q.id}"
        placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì§€ì› ë™ê¸°)" 
        oninput="handleUserQuestionChange(this.dataset.id, this.value)"
      >${q.text}</textarea>
      <button class="delete-btn" onclick="removeUserQuestion(${q.id})">
        &times;
      </button>
    `;
        container.appendChild(item);
      });

      // ìµœëŒ€ ì§ˆë¬¸ ê°œìˆ˜ ì œí•œ (5ê°œ)ì— ë”°ë¼ ì¶”ê°€ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      document.getElementById('addUserQuestionBtn').disabled = userQuestions.length >= 5;
    }

    // ì‚¬ìš©ì ì§ˆë¬¸ ì¶”ê°€
    function addUserQuestion() {
      if (userQuestions.length >= 5) {
        alert('ì§ˆë¬¸ì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      const newId = userQuestions.length > 0 ? Math.max(...userQuestions.map(q => q.id)) + 1 : 1;
      userQuestions.push({ id: newId, text: '' });
      renderUserQuestions();
    }

    // ì‚¬ìš©ì ì§ˆë¬¸ ì‚­ì œ (íŒì—… í¬í•¨)
    function removeUserQuestion(id) {
      if (confirm('ì •ë§ë¡œ ì´ ì§ˆë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        userQuestions = userQuestions.filter(q => q.id !== id);
        renderUserQuestions();
      }
    }

    // ì‚¬ìš©ì ì§ˆë¬¸ ë‚´ìš© ë³€ê²½ ì²˜ë¦¬
    function handleUserQuestionChange(id, newText) {
      const q = userQuestions.find(q => String(q.id) === String(id));
      if (q) {
        q.text = newText;
      }
    }

    // ==================== ê¸°ì¡´ saveUserQuestions í•¨ìˆ˜ (ì¬í™•ì¸ìš©) ====================

    async function saveUserQuestions() {
      if (!confirm('í˜„ì¬ ì§ˆë¬¸ ëª©ë¡ì„ ì €ì¥í•˜ê³  ë©´ì ‘ ì—°ìŠµ ì§ˆë¬¸ìœ¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      // ë¹ˆ ì…ë ¥ ì œê±°
      userQuestions = userQuestions.filter(q => q.text.trim() !== '');

      if (userQuestions.length === 0) {
        alert('ì €ì¥í•  ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        renderUserQuestions();
        return;
      }

      try {
        const res = await fetch(API_BASE + '/api/practice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveUserQuestions',
            interviewId: currentUser.interviewId,
            userQuestions
          })
        });

        if (res.ok) {
          alert('ë‚´ê°€ ì„¤ì •í•œ ì§ˆë¬¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

          // â­ ì„œë²„ì—ì„œ ë‹¤ì‹œ ìµœì‹ ê°’ ë°˜í™˜ & ìƒíƒœ ë™ê¸°í™”
          await loadUserQuestions();

          // UI ì¦‰ì‹œ ë°˜ì˜
          renderUserQuestions();
          renderQuestionSelect();
          updateCurrentQuestion();
        } else {
          alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

      } catch (err) {
        alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error(err);
      }
    }


    // ==================== ì—°ìŠµ ê¸°ë¡ ê´€ë¦¬ ====================
    async function loadPractices() {
      if (!currentUser) return;

      try {
        const res = await fetch(API_BASE + '/api/practice?action=getPractices&interviewId=' + currentUser.interviewId);
        if (res.ok) {
          const data = await res.json();
          practices = data.practices || [];
        }
      } catch (err) {
        console.error('ì—°ìŠµ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
      }

      updateProgress();
      renderResults();
    }

    function updateProgress() {
      const count = practices.length;
      document.getElementById('progressCount').textContent = count + ' / 3 íšŒ';
      document.getElementById('progressFill').style.width = (count / 3 * 100) + '%';

      // ì§„í–‰ ë¼ë²¨ ì—…ë°ì´íŠ¸
      for (let i = 1; i <= 3; i++) {
        const label = document.getElementById('prog' + i);
        if (i <= count) {
          label.classList.add('completed');
          label.classList.remove('active');
        } else if (i === count + 1) {
          label.classList.add('active');
          label.classList.remove('completed');
        } else {
          label.classList.remove('active', 'completed');
        }
      }

      // 3íšŒ ì™„ë£Œ ì‹œ ì œí•œ
      if (count >= 3) {
        document.getElementById('limitAlert').classList.remove('hidden');
        document.getElementById('recordBtn').disabled = true;
      } else {
        document.getElementById('limitAlert').classList.add('hidden');
        document.getElementById('recordBtn').disabled = false;
      }
    }

    function renderResults() {
      const grid = document.getElementById('attemptGrid');
      const noResults = document.getElementById('noResults');
      const detail = document.getElementById('resultDetail');

      // 3ê°œ íšŒì°¨ ì¹´ë“œ ìƒì„± (ì™„ë£Œ/ë¯¸ì™„ë£Œ ìƒíƒœ í¬í•¨)
      let html = '';
      for (let i = 0; i < 3; i++) {
        const p = practices[i];
        const isCompleted = !!p;
        const isLocked = !isCompleted;

        if (isCompleted) {
          html += `<div class="attempt-card ${i === 0 ? 'selected' : ''}" onclick="viewResult(${i})">
        <div class="attempt-number">${i + 1}íšŒì°¨</div>
        <span class="attempt-status status-completed">âœ“ ì™„ë£Œ</span>
        <div class="attempt-date">${formatDate(p.timestamp)}</div>
        <div class="attempt-question">${truncate(p.question, 20)}</div>
      </div>`;
        } else {
          html += `<div class="attempt-card locked">
        <div class="attempt-number">${i + 1}íšŒì°¨</div>
        <span class="attempt-status status-not-started">ğŸ”’ ë¯¸ì™„ë£Œ</span>
        <div class="attempt-date">-</div>
        <div class="attempt-question">ì—°ìŠµì„ ì§„í–‰í•´ì£¼ì„¸ìš”</div>
      </div>`;
        }
      }
      grid.innerHTML = html;

      if (practices.length === 0) {
        noResults.classList.remove('hidden');
        detail.classList.add('hidden');
      } else {
        noResults.classList.add('hidden');
        // ì²« ë²ˆì§¸ ê²°ê³¼ ìë™ í‘œì‹œ
        viewResult(0);
      }
    }

    function viewResult(index) {
      const p = practices[index];
      if (!p) return;

      // ì¹´ë“œ ì„ íƒ í‘œì‹œ
      document.querySelectorAll('.attempt-card').forEach((card, i) => {
        card.classList.toggle('selected', i === index);
      });

      // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('detailTitle').textContent = (index + 1) + 'íšŒì°¨ ë¶„ì„ ê²°ê³¼';
      document.getElementById('detailDate').textContent = formatDate(p.timestamp);
      document.getElementById('detailQuestion').textContent = p.question;
      document.getElementById('detailTranscript').textContent = p.transcript || '(í…ìŠ¤íŠ¸ ë³€í™˜ ê²°ê³¼ ì—†ìŒ)';

      // ìŒì„± ë¶„ì„ ê²°ê³¼ ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ì„ ì¡°ê±´ë¶€ë¡œ ë³€ê²½)
      const voiceAnalysisSection = document.getElementById('voiceAnalysisSection');
      if (practice.voiceAnalysis && Object.keys(practice.voiceAnalysis).length > 0) {
        voiceAnalysisSection.classList.remove('hidden');
        renderVoiceAnalysis(practice.voiceAnalysis);
      } else {
        voiceAnalysisSection.classList.add('hidden');
      }

      // ì˜ìƒ ë¶„ì„ ê²°ê³¼ ë Œë”ë§ (ìƒˆë¡œ ì¶”ê°€)
      const videoAnalysisResultSection = document.getElementById('videoAnalysisResultSection');
      if (practice.videoAnalysis && Object.keys(practice.videoAnalysis).length > 0) {
        videoAnalysisResultSection.classList.remove('hidden');
        renderVideoAnalysis(practice.videoAnalysis);
      } else {
        videoAnalysisResultSection.classList.add('hidden');
      }

      // AI í”¼ë“œë°±ì„ ëŒ€ì‹œë³´ë“œ ì¹´ë“œë¡œ ë Œë”ë§
      renderFeedbackDashboard(p.feedback);

      document.getElementById('resultDetail').classList.remove('hidden');

      // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
      const detail = document.getElementById('resultDetail');
      detail.style.animation = 'none';
      setTimeout(() => {
        detail.style.animation = 'slideDown 0.3s ease';
      }, 10);
    }

    // ìŒì„± ë¶„ì„ ê²°ê³¼ ë Œë”ë§ (í™•ì¥)
    function renderVoiceAnalysis(voiceAnalysis) {
      const section = document.getElementById('voiceAnalysisSection');
      const grid = document.getElementById('voiceAnalysisGrid');

      if (!voiceAnalysis) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');

      // í‰ê°€ ë“±ê¸‰ í•¨ìˆ˜ë“¤
      const getVolumeStatus = (percent) => {
        if (percent >= 60 && percent <= 90) return { label: 'ì ë‹¹í•¨', class: 'excellent', icon: 'âœ“' };
        if (percent >= 40 && percent < 60) return { label: 'ì¡°ê¸ˆ ì‘ìŒ', class: 'warning', icon: '!' };
        if (percent > 90) return { label: 'ì¡°ê¸ˆ í¼', class: 'warning', icon: '!' };
        return { label: 'ë„ˆë¬´ ì‘ìŒ', class: 'low', icon: 'âœ—' };
      };

      const getSpeakingStatus = (ratio) => {
        if (ratio >= 70) return { label: 'ì¢‹ìŒ', class: 'excellent', icon: 'âœ“' };
        if (ratio >= 50) return { label: 'ë³´í†µ', class: 'good', icon: 'â—‹' };
        if (ratio >= 30) return { label: 'ì¹¨ë¬µ ë§ìŒ', class: 'warning', icon: '!' };
        return { label: 'ì¹¨ë¬µ ê³¼ë‹¤', class: 'low', icon: 'âœ—' };
      };

      const getWpmStatus = (wpm) => {
        if (wpm >= 80 && wpm <= 120) return { label: 'ì´ìƒì ', class: 'excellent', icon: 'âœ“' };
        if (wpm >= 60 && wpm < 80) return { label: 'ì¡°ê¸ˆ ëŠë¦¼', class: 'good', icon: 'â—‹' };
        if (wpm > 120 && wpm <= 150) return { label: 'ì¡°ê¸ˆ ë¹ ë¦„', class: 'warning', icon: '!' };
        if (wpm < 60) return { label: 'ëŠë¦¼', class: 'warning', icon: '!' };
        return { label: 'ë§¤ìš° ë¹ ë¦„', class: 'low', icon: 'âœ—' };
      };

      const getFillerStatus = (ratio) => {
        if (ratio <= 3) return { label: 'ì¢‹ìŒ', class: 'excellent', icon: 'âœ“' };
        if (ratio <= 7) return { label: 'ë³´í†µ', class: 'good', icon: 'â—‹' };
        if (ratio <= 12) return { label: 'ì£¼ì˜', class: 'warning', icon: '!' };
        return { label: 'ê°œì„  í•„ìš”', class: 'low', icon: 'âœ—' };
      };

      const getEnergyStatus = (level) => {
        if (level >= 60) return { label: 'í™œê¸°ì°¸', class: 'excellent', icon: 'âœ“' };
        if (level >= 40) return { label: 'ì ë‹¹í•¨', class: 'good', icon: 'â—‹' };
        if (level >= 20) return { label: 'ì°¨ë¶„í•¨', class: 'warning', icon: 'â—‹' };
        return { label: 'ë‚®ìŒ', class: 'low', icon: '!' };
      };

      const getTrendPattern = (pattern) => {
        switch (pattern) {
          case 'increasing': return { label: 'ì ì  í™œë°œ', class: 'excellent', icon: 'ğŸ“ˆ', desc: 'í›„ë°˜ìœ¼ë¡œ ê°ˆìˆ˜ë¡ ì—ë„ˆì§€ê°€ ì˜¬ë¼ê°”ì–´ìš”. ì¢‹ì€ íŒ¨í„´ì´ì—ìš”!' };
          case 'decreasing': return { label: 'ì ì  ê°ì†Œ', class: 'warning', icon: 'ğŸ“‰', desc: 'í›„ë°˜ì— ì—ë„ˆì§€ê°€ ë–¨ì–´ì¡Œì–´ìš”. ë§ˆë¬´ë¦¬ê¹Œì§€ í˜ì„ ìœ ì§€í•´ë³´ì„¸ìš”.' };
          case 'peakMiddle': return { label: 'ì¤‘ë°˜ í”¼í¬', class: 'good', icon: 'ğŸ“Š', desc: 'ì¤‘ë°˜ì— ê°€ì¥ í™œë°œí–ˆì–´ìš”. ì•ˆì •ì ì¸ íŒ¨í„´ì…ë‹ˆë‹¤.' };
          default: return { label: 'ì•ˆì •ì ', class: 'excellent', icon: 'â¡ï¸', desc: 'ì¼ì •í•œ ì—ë„ˆì§€ë¥¼ ìœ ì§€í–ˆì–´ìš”.' };
        }
      };

      const volumeStatus = getVolumeStatus(voiceAnalysis.volumePercent);
      const speakingStatus = getSpeakingStatus(voiceAnalysis.speakingRatio);
      const wpmStatus = getWpmStatus(voiceAnalysis.wpm);

      // í™•ì¥ ë¶„ì„ ë°ì´í„° (ì´ì „ ë°ì´í„°ì™€ì˜ í˜¸í™˜ì„±)
      const fillerWords = voiceAnalysis.fillerWords || { count: 0, ratio: 0, details: [] };
      const longSilences = voiceAnalysis.longSilences || { count: 0, avgDuration: 0, details: [] };
      const segmentTrend = voiceAnalysis.segmentTrend || { early: 100, middle: 100, late: 100 };
      const trendPattern = voiceAnalysis.trendPattern || 'stable';
      const energyLevel = voiceAnalysis.energyLevel || 50;
      const wpmGuide = voiceAnalysis.wpmGuide || '';
      const wpmStatusClass = voiceAnalysis.wpmStatus || 'good';

      const fillerStatus = getFillerStatus(fillerWords.ratio);
      const energyStatus = getEnergyStatus(energyLevel);
      const trendInfo = getTrendPattern(trendPattern);

      // ë¶„ì„ ìš”ì•½ ìƒì„±
      let summaryPoints = [];
      if (wpmStatus.class === 'excellent') summaryPoints.push('ë§í•˜ê¸° ì†ë„ê°€ ì´ìƒì ì´ì—ìš”');
      if (fillerWords.count > 5) summaryPoints.push(`í•„ëŸ¬ ì›Œë“œë¥¼ ${fillerWords.count}ë²ˆ ì‚¬ìš©í–ˆì–´ìš”`);
      if (longSilences.count > 0) summaryPoints.push(`${longSilences.count}ë²ˆì˜ ê¸´ ì¹¨ë¬µì´ ìˆì—ˆì–´ìš”`);
      if (trendPattern === 'decreasing') summaryPoints.push('í›„ë°˜ì— ì—ë„ˆì§€ê°€ ë–¨ì–´ì¡Œì–´ìš”');

      // í•„ëŸ¬ ì›Œë“œ íƒœê·¸ HTML
      let fillerTagsHtml = '';
      if (fillerWords.details && fillerWords.details.length > 0) {
        fillerTagsHtml = fillerWords.details.map(f =>
          `<span class="filler-word-tag">"${f.word}"<span class="count">${f.count}íšŒ</span></span>`
        ).join('');
      }

      // ê¸´ ì¹¨ë¬µ ì¹´ë“œ HTML
      let silenceCardsHtml = '';
      if (longSilences.details && longSilences.details.length > 0) {
        silenceCardsHtml = longSilences.details.slice(0, 3).map((s, i) => {
          const timeInSec = Math.round(s.startTime / 1000);
          const durationSec = (s.duration / 1000).toFixed(1);
          return `<div class="silence-card">
        <div class="silence-card-header">
          <span class="silence-time">â±ï¸ ${timeInSec}ì´ˆ ì‹œì </span>
          <span class="silence-duration">${durationSec}ì´ˆê°„ ì¹¨ë¬µ</span>
        </div>
      </div>`;
        }).join('');
      }

      // ì—ë„ˆì§€ ë¯¸í„° HTML (10ì¹¸)
      const energyBars = Array(10).fill(0).map((_, i) => {
        const threshold = (i + 1) * 10;
        const isFilled = energyLevel >= threshold;
        let colorClass = 'low';
        if (i >= 7) colorClass = 'max';
        else if (i >= 5) colorClass = 'high';
        else if (i >= 3) colorClass = 'mid';
        return `<div class="energy-bar ${isFilled ? 'filled ' + colorClass : ''}"></div>`;
      }).join('');

      // WPM ê°€ì´ë“œ ë°•ìŠ¤ í´ë˜ìŠ¤
      let wpmGuideClass = '';
      if (wpmStatusClass === 'ideal') wpmGuideClass = 'ideal';
      else if (wpmStatusClass === 'slow' || wpmStatusClass === 'moderate') wpmGuideClass = 'slow';
      else if (wpmStatusClass === 'fast' || wpmStatusClass === 'veryFast') wpmGuideClass = 'fast';

      grid.innerHTML = `
    <!-- ë¶„ì„ ìš”ì•½ -->
    ${summaryPoints.length > 0 ? `
    <div class="analysis-summary" style="grid-column: 1 / -1;">
      <div class="summary-title">ğŸ’¡ í•œëˆˆì— ë³´ê¸°</div>
      <div class="summary-text">${summaryPoints.join(' Â· ')}</div>
    </div>
    ` : ''}
    
    <!-- 1. ë§ ë¹ ë¥´ê¸° (WPM) + ê°€ì´ë“œ -->
    <div class="voice-metric">
      <div class="voice-metric-header">
        <span class="voice-metric-label">âš¡ ë§í•˜ê¸° ì†ë„</span>
        <span class="voice-status-badge ${wpmStatus.class}">${wpmStatus.icon} ${wpmStatus.label}</span>
      </div>
      <div class="voice-meter">
        <div class="voice-meter-fill ${wpmStatus.class}" style="width: ${Math.min(100, (voiceAnalysis.wpm / 150) * 100)}%"></div>
      </div>
      <div class="voice-metric-desc">ë¶„ë‹¹ <strong>${voiceAnalysis.wpm}ë‹¨ì–´</strong> (ì´ ${voiceAnalysis.wordCount}ë‹¨ì–´, ${voiceAnalysis.recordingDuration}ì´ˆ) Â· í•œêµ­ì–´ ê¸°ì¤€ 80~120 WPMì´ ì ë‹¹</div>
      ${wpmGuide ? `<div class="wpm-guide-box ${wpmGuideClass}"><div class="wpm-guide-text">ğŸ’¬ ${wpmGuide}</div></div>` : ''}
    </div>
    
    <!-- 2. í•„ëŸ¬ ì›Œë“œ ë¶„ì„ -->
    <div class="voice-metric">
      <div class="voice-metric-header">
        <span class="voice-metric-label">ğŸ—£ï¸ í•„ëŸ¬ ì›Œë“œ</span>
        <span class="voice-status-badge ${fillerStatus.class}">${fillerStatus.icon} ${fillerStatus.label}</span>
      </div>
      <div class="voice-meter">
        <div class="voice-meter-fill ${fillerStatus.class}" style="width: ${Math.min(100, fillerWords.ratio * 5)}%"></div>
      </div>
      <div class="voice-metric-desc">"ìŒ", "ì–´", "ê·¸" ë“± ${fillerWords.count}ë²ˆ ì‚¬ìš© (ì „ì²´ì˜ ${fillerWords.ratio}%)</div>
      ${fillerTagsHtml ? `<div class="filler-word-list">${fillerTagsHtml}</div>` : '<div style="margin-top: 0.5rem; color: #6EE7B7; font-size: 0.9rem;">âœ“ í•„ëŸ¬ ì›Œë“œ ì—†ì´ ê¹”ë”í•˜ê²Œ ë§í–ˆì–´ìš”!</div>'}
    </div>
    
    <!-- 3. ê¸´ ì¹¨ë¬µ ë¶„ì„ -->
    <div class="voice-metric">
      <div class="voice-metric-header">
        <span class="voice-metric-label">â¸ï¸ ê¸´ ì¹¨ë¬µ (2ì´ˆ+)</span>
        <span class="voice-status-badge ${longSilences.count === 0 ? 'excellent' : (longSilences.count <= 2 ? 'good' : 'warning')}">${longSilences.count === 0 ? 'âœ“ ì—†ìŒ' : longSilences.count + 'íšŒ'}</span>
      </div>
      ${longSilences.count > 0 ? `
        <div class="voice-metric-desc">í‰ê·  ${longSilences.avgDuration}ì´ˆ ë™ì•ˆ ì¹¨ë¬µ. ê¸´ ì¹¨ë¬µì€ ë©´ì ‘ê´€ì—ê²Œ ì¤€ë¹„ ë¶€ì¡±ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆì–´ìš”.</div>
        ${silenceCardsHtml}
      ` : '<div class="voice-metric-desc" style="color: #6EE7B7;">âœ“ 2ì´ˆ ì´ìƒì˜ ê¸´ ì¹¨ë¬µ ì—†ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë§í–ˆì–´ìš”!</div>'}
    </div>
    
    <!-- 4. ì—ë„ˆì§€ ë ˆë²¨ -->
    <div class="voice-metric">
      <div class="voice-metric-header">
        <span class="voice-metric-label">ğŸ”¥ ì—ë„ˆì§€ ë ˆë²¨</span>
        <span class="voice-status-badge ${energyStatus.class}">${energyStatus.icon} ${energyStatus.label}</span>
      </div>
      <div class="energy-meter">${energyBars}</div>
      <div class="voice-metric-desc">ìŒëŸ‰ ë³€í™”ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸¡ì •í•œ ë°œí‘œì˜ í™œê¸°ì…ë‹ˆë‹¤. (${energyLevel}%)</div>
    </div>
    
    <!-- 5. í‰ê·  ìŒëŸ‰ -->
    <div class="voice-metric">
      <div class="voice-metric-header">
        <span class="voice-metric-label">ğŸ”Š í‰ê·  ìŒëŸ‰</span>
        <span class="voice-status-badge ${volumeStatus.class}">${volumeStatus.icon} ${volumeStatus.label}</span>
      </div>
      <div class="voice-meter">
        <div class="voice-meter-fill ${volumeStatus.class}" style="width: ${voiceAnalysis.volumePercent}%"></div>
      </div>
      <div class="voice-metric-desc">ë§ˆì´í¬ì— ì¡íŒ í‰ê·  ìŒëŸ‰ì…ë‹ˆë‹¤. (${voiceAnalysis.volumePercent}%)</div>
    </div>
    
    <!-- 6. ë§í•˜ê¸° ë¹„ìœ¨ -->
    <div class="voice-metric">
      <div class="voice-metric-header">
        <span class="voice-metric-label">ğŸ’¬ ë§í•˜ê¸° ë¹„ìœ¨</span>
        <span class="voice-status-badge ${speakingStatus.class}">${speakingStatus.icon} ${speakingStatus.label}</span>
      </div>
      <div class="voice-meter">
        <div class="voice-meter-fill ${speakingStatus.class}" style="width: ${voiceAnalysis.speakingRatio}%"></div>
      </div>
      <div class="voice-metric-desc">${voiceAnalysis.speakingRatio}% ë§í•˜ê¸° / ${100 - voiceAnalysis.speakingRatio}% ì¹¨ë¬µ</div>
    </div>
  `;
    }

    function renderFeedbackDashboard(feedback) {
      const container = document.getElementById('detailFeedback');

      if (!feedback) {
        container.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">(í”¼ë“œë°± ì—†ìŒ)</p>';
        return;
      }

      // í”¼ë“œë°± í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ì„¹ì…˜ë³„ë¡œ ë¶„ë¦¬
      const sections = parseFeedback(feedback);

      let html = `
    <!-- 1. ë‹µë³€ì˜ ì ì ˆì„± -->
    <div class="feedback-card card-relevance">
      <div class="feedback-card-header">
        <span class="feedback-card-icon">ğŸ“‹</span>
        <span class="feedback-card-title">ë‹µë³€ì˜ ì ì ˆì„±</span>
      </div>
      <div class="feedback-card-content">${sections.relevance || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
    </div>
    
    <!-- 2. ê°•ì  -->
    <div class="feedback-card card-strength">
      <div class="feedback-card-header">
        <span class="feedback-card-icon">âœ…</span>
        <span class="feedback-card-title">ê°•ì  (ì˜í•œ ë¶€ë¶„)</span>
      </div>
      <div class="feedback-card-content">${sections.strength || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
    </div>
    
    <!-- 3. ê°œì„ ì  -->
    <div class="feedback-card card-improve">
      <div class="feedback-card-header">
        <span class="feedback-card-icon">ğŸ”§</span>
        <span class="feedback-card-title">ê°œì„ ì  (ë³´ì™„í•  ë¶€ë¶„)</span>
      </div>
      <div class="feedback-card-content">${sections.improvement || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
    </div>
    
    <!-- 4. êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ -->
    <div class="feedback-card card-suggestion full-width">
      <div class="feedback-card-header">
        <span class="feedback-card-icon">ğŸ’</span>
        <span class="feedback-card-title">êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ</span>
      </div>
      <div class="feedback-card-content">${sections.suggestion || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
    </div>
  `;

      container.innerHTML = html;
    }

    function parseFeedback(feedback) {
      // í”¼ë“œë°± í…ìŠ¤íŠ¸ë¥¼ ì„¹ì…˜ë³„ë¡œ íŒŒì‹±
      const sections = {
        relevance: '',
        strength: '',
        improvement: '',
        suggestion: ''
      };

      // ë‹¤ì–‘í•œ íŒ¨í„´ìœ¼ë¡œ ì„¹ì…˜ ë¶„ë¦¬ ì‹œë„
      const text = feedback.replace(/<br>/g, '\n');

      // íŒ¨í„´ 1: ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ì„¹ì…˜ (1. ë‹µë³€ì˜ ì ì ˆì„±, 2. ê°•ì  ë“±)
      const patterns = [
        { key: 'relevance', regex: /(?:1\.|#+\s*1\.|ë‹µë³€ì˜ ì ì ˆì„±|ì ì ˆì„±)[^\n]*\n?([\s\S]*?)(?=(?:2\.|#+\s*2\.|ê°•ì |##|$))/i },
        { key: 'strength', regex: /(?:2\.|#+\s*2\.|ê°•ì )[^\n]*\n?([\s\S]*?)(?=(?:3\.|#+\s*3\.|ê°œì„ ì |##|$))/i },
        { key: 'improvement', regex: /(?:3\.|#+\s*3\.|ê°œì„ ì |ë³´ì™„)[^\n]*\n?([\s\S]*?)(?=(?:4\.|#+\s*4\.|ê°œì„  ì œì•ˆ|êµ¬ì²´ì |##|$))/i },
        { key: 'suggestion', regex: /(?:4\.|#+\s*4\.|ê°œì„  ì œì•ˆ|êµ¬ì²´ì ì¸ ê°œì„ )[^\n]*\n?([\s\S]*?)$/i }
      ];

      patterns.forEach(({ key, regex }) => {
        const match = text.match(regex);
        if (match && match[1]) {
          sections[key] = match[1].trim().replace(/\n/g, '<br>');
        }
      });

      // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ suggestionì— ë„£ê¸°
      if (!sections.relevance && !sections.strength && !sections.improvement && !sections.suggestion) {
        sections.suggestion = feedback.replace(/\n/g, '<br>');
      }

      return sections;
    }


    // ==================== ë…¹ìŒ ê¸°ëŠ¥ ====================
    async function toggleRecording() {
      if (practices.length >= 3) {
        alert('ì—°ìŠµ ê¸°íšŒ 3íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.');
        return;
      }

      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    }

    async function startRecording() {
      try {
        // ì˜ìƒ ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
        videoAnalysisData = {
          expressionSamples: [], gazeDirections: [], headPoses: [],
          cameraLookRatio: 0, dominantExpression: null, expressionDistribution: {},
          stabilityScore: 0, smileRatio: 0
        };

        const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // ì˜ìƒ ëª¨ë“œì¼ ê²½ìš° ë¹„ë””ì˜¤ ë…¹í™”ë„ ì‹œì‘
        if (analysisMode === 'video' && videoStream) {
          const combinedStream = new MediaStream([
            ...videoStream.getVideoTracks(),
            ...audioStream.getAudioTracks()
          ]);

          videoRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });
          videoChunks = [];
          videoRecorder.ondataavailable = (e) => videoChunks.push(e.data);
          videoRecorder.onstop = () => { videoBlob = new Blob(videoChunks, { type: 'video/webm' }); };
          videoRecorder.start();

          const videoStatus = document.getElementById('videoStatus');
          videoStatus.classList.add('recording');
          document.getElementById('videoStatusText').textContent = 'ë…¹í™” ì¤‘...';
        }

        // ê¸°ì¡´ ì˜¤ë””ì˜¤ ë…¹ìŒ ì½”ë“œ...
        mediaRecorder = new MediaRecorder(audioStream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          audioUrl = URL.createObjectURL(audioBlob);
          document.getElementById('audioPlayback').src = audioUrl;
          document.getElementById('audioPlayer').classList.remove('hidden');
          audioStream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        isRecording = true;

        // UI ì—…ë°ì´íŠ¸
        const btn = document.getElementById('recordBtn');
        btn.classList.remove('start');
        btn.classList.add('stop');
        btn.textContent = 'â¹';
        document.getElementById('recordingStatus').classList.remove('hidden');
        document.getElementById('waveformOverlay').classList.add('hidden');

        // ëª¨ë“œ ì„ íƒ ë¹„í™œì„±í™”
        document.getElementById('modeSelector').style.pointerEvents = 'none';
        document.getElementById('modeSelector').style.opacity = '0.5';

        // íƒ€ì´ë¨¸ ì‹œì‘
        timeLeft = 60;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
          timeLeft--;
          updateTimerDisplay();
          if (timeLeft <= 0) stopRecording();
        }, 1000);

        startWaveform(audioStream);
      } catch (err) {
        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        console.error(err);
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();

      // ì˜ìƒ ë…¹í™” ì¤‘ì§€
      if (videoRecorder && videoRecorder.state !== 'inactive') {
        videoRecorder.stop();
        const videoStatus = document.getElementById('videoStatus');
        videoStatus.classList.remove('recording');
        document.getElementById('videoStatusText').textContent = 'ë…¹í™” ì™„ë£Œ';
      }

      isRecording = false;
      clearInterval(timerInterval);
      stopWaveform();

      // UI ì—…ë°ì´íŠ¸
      const btn = document.getElementById('recordBtn');
      btn.classList.remove('stop');
      btn.classList.add('start');
      btn.textContent = 'ğŸ¤';
      btn.disabled = true;
      document.getElementById('recordingStatus').classList.add('hidden');

      // ëª¨ë“œ ì„ íƒ ë‹¤ì‹œ í™œì„±í™”
      document.getElementById('modeSelector').style.pointerEvents = 'auto';
      document.getElementById('modeSelector').style.opacity = '1';

      // ì˜ìƒ ë¶„ì„ ë°ì´í„° ì²˜ë¦¬
      if (analysisMode === 'video') processVideoAnalysisData();
    }

    function resetRecording() {
      audioBlob = null;
      audioUrl = null;
      audioChunks = [];

      // ì˜ìƒ ë¶„ì„ì„ ìœ„í•´ ìƒˆë¡œ ì¶”ê°€ëœ ì´ˆê¸°í™”
      videoBlob = null;
      videoChunks = [];

      // ì˜ìƒ ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
      videoAnalysisData = {
        expressionSamples: [], gazeDirections: [], headPoses: [],
        cameraLookRatio: 0, dominantExpression: null, expressionDistribution: {},
        stabilityScore: 0, smileRatio: 0
      };
      // ì‹¤ì‹œê°„ ë¶„ì„ ì¹´ìš´íŠ¸ë„ ì´ˆê¸°í™” (ì´ì „ ë‹¨ê³„ì—ì„œ ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ë¶€ì— ì¶”ê°€ë˜ì—ˆì–´ì•¼ í•¨)
      lookRatioCount = 0;
      totalFrameCount = 0;
      smileCount = 0;

      // ê¸°ì¡´ ìŒì„±/UI ê´€ë ¨ ì´ˆê¸°í™”
      document.getElementById('audioPlayer').classList.add('hidden');
      document.getElementById('recordBtn').disabled = (practices.length >= 3);
      document.getElementById('waveformOverlay').classList.remove('hidden');
      timeLeft = 60;
      updateTimerDisplay();
      document.getElementById('timerDisplay').classList.remove('warning', 'danger');

      // ë¹„ë””ì˜¤ ìƒíƒœ ì´ˆê¸°í™”
      if (analysisMode === 'video') {
        const videoStatus = document.getElementById('videoStatus');
        if (videoStatus) {
          videoStatus.classList.remove('recording');
          // ì¹´ë©”ë¼ê°€ ì¼œì ¸ ìˆë‹¤ë©´, ìƒíƒœë¥¼ 'ì¤€ë¹„ ì™„ë£Œ'ë¡œ ë³€ê²½
          document.getElementById('videoStatusText').textContent = 'ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ';
        }
      }
    }

    function updateTimerDisplay() {
      const display = document.getElementById('timerDisplay');
      const mins = Math.floor(timeLeft / 60);
      const secs = timeLeft % 60;
      display.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');

      display.classList.remove('warning', 'danger');
      if (timeLeft <= 10) {
        display.classList.add('danger');
      } else if (timeLeft <= 20) {
        display.classList.add('warning');
      }
    }

    // íŒŒí˜• ì‹œê°í™” + ìŒì„± ë¶„ì„ ë°ì´í„° ìˆ˜ì§‘ (í™•ì¥)
    function startWaveform(stream) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      const source = audioContext.createMediaStreamSource(stream);
      source.connect(analyser);

      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      const startTime = performance.now();
      let lastVolume = 0;

      // ìŒì„± ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™” (í™•ì¥)
      voiceAnalysisData = {
        volumeSamples: [],
        silenceTime: 0,
        speakingTime: 0,
        lastSampleTime: startTime,
        silenceThreshold: 15,
        longSilences: [],
        currentSilenceStart: null,
        segmentVolumes: { early: [], middle: [], late: [] },
        recordingStartTime: startTime,
        peakVolumes: [],
        volumeChanges: []
      };

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);

        // === ìŒì„± ë¶„ì„ ë°ì´í„° ìˆ˜ì§‘ (í™•ì¥) ===
        const now = performance.now();
        const deltaTime = now - voiceAnalysisData.lastSampleTime;
        const elapsedTime = now - voiceAnalysisData.recordingStartTime;
        voiceAnalysisData.lastSampleTime = now;

        // í‰ê·  ë³¼ë¥¨ ê³„ì‚° (í˜„ì¬ í”„ë ˆì„)
        let sum = 0;
        let maxInFrame = 0;
        for (let i = 0; i < bufferLength; i++) {
          sum += dataArray[i];
          if (dataArray[i] > maxInFrame) maxInFrame = dataArray[i];
        }
        const avgVolume = sum / bufferLength;
        voiceAnalysisData.volumeSamples.push(avgVolume);

        // í”¼í¬ ë³¼ë¥¨ ê¸°ë¡ (ì—ë„ˆì§€ ë ˆë²¨ìš©)
        voiceAnalysisData.peakVolumes.push(maxInFrame);

        // ë³¼ë¥¨ ë³€í™”ëŸ‰ ê¸°ë¡ (í™œê¸° ì¸¡ì •ìš©)
        const volumeChange = Math.abs(avgVolume - lastVolume);
        voiceAnalysisData.volumeChanges.push(volumeChange);
        lastVolume = avgVolume;

        // êµ¬ê°„ë³„ ë³¼ë¥¨ ë¶„ë¥˜ (ì´ˆë°˜ 20ì´ˆ / ì¤‘ë°˜ / í›„ë°˜ 20ì´ˆ)
        const totalDuration = 60000; // 60ì´ˆ = 60000ms
        if (elapsedTime < 20000) {
          voiceAnalysisData.segmentVolumes.early.push(avgVolume);
        } else if (elapsedTime < 40000) {
          voiceAnalysisData.segmentVolumes.middle.push(avgVolume);
        } else {
          voiceAnalysisData.segmentVolumes.late.push(avgVolume);
        }

        // ì¹¨ë¬µ vs ë§í•˜ê¸° ì‹œê°„ ê³„ì‚° + ê¸´ ì¹¨ë¬µ ê°ì§€
        if (avgVolume < voiceAnalysisData.silenceThreshold) {
          voiceAnalysisData.silenceTime += deltaTime;

          // ê¸´ ì¹¨ë¬µ ì‹œì‘ ê°ì§€
          if (voiceAnalysisData.currentSilenceStart === null) {
            voiceAnalysisData.currentSilenceStart = now;
          }
        } else {
          voiceAnalysisData.speakingTime += deltaTime;

          // ê¸´ ì¹¨ë¬µ ì¢…ë£Œ - 2ì´ˆ ì´ìƒì´ë©´ ê¸°ë¡
          if (voiceAnalysisData.currentSilenceStart !== null) {
            const silenceDuration = now - voiceAnalysisData.currentSilenceStart;
            if (silenceDuration >= 2000) { // 2ì´ˆ ì´ìƒ
              voiceAnalysisData.longSilences.push({
                startTime: voiceAnalysisData.currentSilenceStart - voiceAnalysisData.recordingStartTime,
                duration: silenceDuration
              });
            }
            voiceAnalysisData.currentSilenceStart = null;
          }
        }
        // === ìŒì„± ë¶„ì„ ë°ì´í„° ìˆ˜ì§‘ ë ===

        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const barHeight = (dataArray[i] / 255) * canvas.height;

          const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
          gradient.addColorStop(0, '#10B981');
          gradient.addColorStop(1, '#34D399');

          ctx.fillStyle = gradient;
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

          x += barWidth + 1;
        }
      }

      draw();
    }

    // í•„ëŸ¬ ì›Œë“œ ê°ì§€
    function detectFillerWords(transcript) {
      if (!transcript) return { count: 0, ratio: 0, details: [] };

      // í•œêµ­ì–´ í•„ëŸ¬ ì›Œë“œ íŒ¨í„´
      const fillerPatterns = [
        { word: 'ìŒ', regex: /\bìŒ+\b/g },
        { word: 'ì–´', regex: /\bì–´+\b/g },
        { word: 'ê·¸', regex: /\bê·¸\b/g },
        { word: 'ì´ì œ', regex: /\bì´ì œ\b/g },
        { word: 'ë­', regex: /\bë­\b/g },
        { word: 'ì•½ê°„', regex: /\bì•½ê°„\b/g },
        { word: 'ì¢€', regex: /\bì¢€\b/g },
        { word: 'ë§‰', regex: /\bë§‰\b/g },
        { word: 'ê·¸ë‹ˆê¹Œ', regex: /\bê·¸ë‹ˆê¹Œ\b/g },
        { word: 'ì•„ë‹ˆ', regex: /\bì•„ë‹ˆ\b/g },
        { word: 'ê·¸ë˜ì„œ', regex: /\bê·¸ë˜ì„œ\b/g },
        { word: 'ì¼ë‹¨', regex: /\bì¼ë‹¨\b/g }
      ];

      const details = [];
      let totalFillers = 0;

      fillerPatterns.forEach(({ word, regex }) => {
        const matches = transcript.match(regex);
        const count = matches ? matches.length : 0;
        if (count > 0) {
          details.push({ word, count });
          totalFillers += count;
        }
      });

      // ì „ì²´ ë‹¨ì–´ ìˆ˜
      const totalWords = transcript.trim().split(/\s+/).filter(w => w.length > 0).length;
      const ratio = totalWords > 0 ? Math.round((totalFillers / totalWords) * 100) : 0;

      // ë§ì´ ì‚¬ìš©ëœ ìˆœìœ¼ë¡œ ì •ë ¬
      details.sort((a, b) => b.count - a.count);

      return {
        count: totalFillers,
        ratio,
        details: details.slice(0, 5) // ìƒìœ„ 5ê°œë§Œ
      };
    }

    // ìŒì„± ë¶„ì„ ê²°ê³¼ ê³„ì‚° (í™•ì¥)
    function calculateVoiceAnalysis(transcript, recordingDuration) {
      const samples = voiceAnalysisData.volumeSamples;

      if (samples.length === 0) {
        // ë°ì´í„°ê°€ ì—†ì–´ë„ ê¸°ë³¸ê°’ ë°˜í™˜ (ë¶„ì„ ê²°ê³¼ì°½ í‘œì‹œë¥¼ ìœ„í•´)
        return {
          volumePercent: 0, speakingRatio: 0, wpm: 0, wordCount: 0, consistencyScore: 0, recordingDuration: 0,
          fillerWords: { count: 0, ratio: 0, details: [] },
          longSilences: { count: 0, avgDuration: 0, details: [] },
          segmentTrend: { early: 0, middle: 0, late: 0 },
          trendPattern: 'stable', energyLevel: 0, dynamicScore: 0,
          wpmGuide: 'ë¶„ì„ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', wpmStatus: 'moderate'
        };
      }

      // 1. í‰ê·  ìŒëŸ‰ (0-100%)
      const avgVolume = samples.reduce((a, b) => a + b, 0) / samples.length;
      const volumePercent = Math.min(100, Math.round((avgVolume / 80) * 100));

      // 2. ë§í•˜ê¸° ë¹„ìœ¨
      const totalTime = voiceAnalysisData.speakingTime + voiceAnalysisData.silenceTime;
      const speakingRatio = totalTime > 0
        ? Math.round((voiceAnalysisData.speakingTime / totalTime) * 100)
        : 0;

      // 3. ë§ ë¹ ë¥´ê¸° (WPM - Words Per Minute)
      const wordCount = transcript ? transcript.trim().split(/\s+/).filter(w => w.length > 0).length : 0;
      const durationMinutes = recordingDuration / 60;
      const wpm = durationMinutes > 0 ? Math.round(wordCount / durationMinutes) : 0;

      // 4. ìŒëŸ‰ ì¼ê´€ì„± (í‘œì¤€í¸ì°¨ ê¸°ë°˜)
      const mean = avgVolume;
      const squaredDiffs = samples.map(v => Math.pow(v - mean, 2));
      const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / squaredDiffs.length;
      const stdDev = Math.sqrt(avgSquaredDiff);
      const consistencyScore = Math.max(0, Math.min(100, Math.round(100 - (stdDev * 2))));

      // === ìƒˆë¡œìš´ ë¶„ì„ í•­ëª©ë“¤ ===

      // 5. í•„ëŸ¬ ì›Œë“œ ë¶„ì„
      const fillerAnalysis = detectFillerWords(transcript);

      // 6. ê¸´ ì¹¨ë¬µ ë¶„ì„ (2ì´ˆ ì´ìƒ)
      const longSilences = voiceAnalysisData.longSilences;
      const longSilenceCount = longSilences.length;
      const avgLongSilenceDuration = longSilenceCount > 0
        ? Math.round(longSilences.reduce((sum, s) => sum + s.duration, 0) / longSilenceCount / 1000 * 10) / 10
        : 0;

      // 7. êµ¬ê°„ë³„ ì†ë„ ë¶„ì„ (ë§ ë¹ ë¥´ê¸° íŠ¸ë Œë“œ)
      const calcSegmentAvg = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
      const earlyAvg = calcSegmentAvg(voiceAnalysisData.segmentVolumes.early);
      const middleAvg = calcSegmentAvg(voiceAnalysisData.segmentVolumes.middle);
      const lateAvg = calcSegmentAvg(voiceAnalysisData.segmentVolumes.late);

      // êµ¬ê°„ë³„ ìƒëŒ€ì  ì—ë„ˆì§€ (ì „ì²´ í‰ê·  ëŒ€ë¹„)
      const segmentTrend = {
        early: avgVolume > 0 ? Math.round((earlyAvg / avgVolume) * 100) : 100,
        middle: avgVolume > 0 ? Math.round((middleAvg / avgVolume) * 100) : 100,
        late: avgVolume > 0 ? Math.round((lateAvg / avgVolume) * 100) : 100
      };

      // íŠ¸ë Œë“œ íŒ¨í„´ ë¶„ì„
      let trendPattern = 'stable'; // ì•ˆì •
      const earlyToLate = segmentTrend.late - segmentTrend.early;
      if (earlyToLate > 15) {
        trendPattern = 'increasing'; // ì ì  í™œë°œ
      } else if (earlyToLate < -15) {
        trendPattern = 'decreasing'; // ì ì  ê°ì†Œ
      } else if (segmentTrend.middle > segmentTrend.early + 10 && segmentTrend.middle > segmentTrend.late + 10) {
        trendPattern = 'peakMiddle'; // ì¤‘ë°˜ í”¼í¬
      }

      // 8. ì—ë„ˆì§€ ë ˆë²¨ (í™œê¸° ì¸¡ì •)
      const peakVolumes = voiceAnalysisData.peakVolumes;
      const avgPeak = peakVolumes.length > 0 ? peakVolumes.reduce((a, b) => a + b, 0) / peakVolumes.length : 0;
      const energyLevel = Math.min(100, Math.round((avgPeak / 150) * 100));

      // ë³¼ë¥¨ ë³€í™”ëŸ‰ìœ¼ë¡œ í™œê¸° ì¸¡ì • (ë³€í™”ê°€ ë§ì„ìˆ˜ë¡ í™œê¸°ì°¸)
      const volumeChanges = voiceAnalysisData.volumeChanges;
      const avgVolumeChange = volumeChanges.length > 0 ? volumeChanges.reduce((a, b) => a + b, 0) / volumeChanges.length : 0;
      const dynamicScore = Math.min(100, Math.round(avgVolumeChange * 5)); // ìŠ¤ì¼€ì¼ë§

      // 9. WPM ê°€ì´ë“œ ë©”ì‹œì§€ (í•œêµ­ì–´ ê¸°ì¤€: 80-120 WPMì´ ì ì •)
      let wpmGuide = '';
      let wpmStatus = 'good';
      if (wpm < 60) {
        wpmGuide = 'ì¡°ê¸ˆ ëŠë¦° í¸ì´ì—ìš”. í•µì‹¬ ë‚´ìš©ì„ ë” ëª…í™•í•˜ê²Œ ì „ë‹¬í•´ë³´ì„¸ìš”.';
        wpmStatus = 'slow';
      } else if (wpm < 80) {
        wpmGuide = 'ì°¨ë¶„í•œ ì†ë„ì˜ˆìš”. ì¤‘ìš”í•œ í¬ì¸íŠ¸ì—ì„œ ê°•ì¡°í•˜ë©´ ì¢‹ê² ì–´ìš”.';
        wpmStatus = 'moderate';
      } else if (wpm <= 120) {
        wpmGuide = 'ì´ìƒì ì¸ ì†ë„ì˜ˆìš”! ë“£ê¸° í¸í•œ í…œí¬ì…ë‹ˆë‹¤.';
        wpmStatus = 'ideal';
      } else if (wpm <= 150) {
        wpmGuide = 'ì¡°ê¸ˆ ë¹ ë¥¸ í¸ì´ì—ìš”. ì¤‘ìš”í•œ ë¶€ë¶„ì—ì„œ ì ì‹œ ì‰¬ì–´ê°€ì„¸ìš”.';
        wpmStatus = 'fast';
      } else {
        wpmGuide = 'ë§ì´ ë¹ ë¥¸ í¸ì´ì—ìš”. ì²œì²œíˆ ë˜ë°•ë˜ë°• ë§í•˜ë©´ ë” ì‹ ë¢°ê°ì„ ì¤„ ìˆ˜ ìˆì–´ìš”.';
        wpmStatus = 'veryFast';
      }

      return {
        // ê¸°ë³¸ ë¶„ì„
        volumePercent,
        speakingRatio,
        wpm,
        wordCount,
        consistencyScore,
        recordingDuration: Math.round(recordingDuration),

        // í™•ì¥ ë¶„ì„
        fillerWords: fillerAnalysis,
        longSilences: {
          count: longSilenceCount,
          avgDuration: avgLongSilenceDuration,
          details: longSilences.slice(0, 5) // ìƒìœ„ 5ê°œ
        },
        segmentTrend,
        trendPattern,
        energyLevel,
        dynamicScore,
        wpmGuide,
        wpmStatus
      };
    }


    function stopWaveform() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
    }

    // ==================== ë¶„ì„ ìš”ì²­ ====================
    async function submitRecording() {
      if (!audioBlob) return;

      document.getElementById('recordingArea').classList.add('hidden');
      document.getElementById('analyzingArea').classList.remove('hidden');

      try {
        // 1. ìŒì„± â†’ í…ìŠ¤íŠ¸ ë³€í™˜
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');

        console.log('Sending audio for transcription...', audioBlob.size, 'bytes');

        const transcribeRes = await fetch(API_BASE + '/api/transcribe', {
          method: 'POST',
          body: formData
        });

        const transcribeData = await transcribeRes.json();

        if (!transcribeRes.ok) {
          console.error('Transcribe error:', transcribeData);
          throw new Error(transcribeData.error || 'ìŒì„± ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        const transcript = transcribeData.text;

        if (!transcript || transcript.trim() === '') {
          throw new Error('ìŒì„±ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë…¹ìŒí•´ì£¼ì„¸ìš”.');
        }

        console.log('Transcription successful:', transcript.substring(0, 50) + '...');

        // 2. AI ë¶„ì„ ìš”ì²­ - ì„ íƒëœ ì§ˆë¬¸ ì‚¬ìš©
        const allQ = getAllQuestions();
        const selectedQ = allQ.find(q => q.id === selectedQuestionId);
        const question = selectedQ?.text || questions[0]?.text || 'ìš°ë¦¬ ê¸°ê´€ì— ì§€ì›í•œ ë™ê¸°ë¥¼ ì†Œê°œí•´ì£¼ì„¸ìš”.';

        const analyzeRes = await fetch(API_BASE + '/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: `ë‹¹ì‹ ì€ ë©´ì ‘ ì½”ì¹˜ì…ë‹ˆë‹¤. ì•„ë˜ ì§ˆë¬¸ì— ëŒ€í•œ ì§€ì›ìì˜ ë‹µë³€ì„ ë¶„ì„í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.

[ì§ˆë¬¸]
${question}

[ì§€ì›ì ë‹µë³€]
${transcript}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:
1. ë‹µë³€ì˜ ì ì ˆì„± (ì§ˆë¬¸ì— ë§ëŠ” ë‹µë³€ì¸ì§€)
2. ê°•ì  (ì˜í•œ ë¶€ë¶„)
3. ê°œì„ ì  (ë³´ì™„í•  ë¶€ë¶„)
4. êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ

ì¹œì ˆí•˜ê³  ê±´ì„¤ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`
          })
        });

        if (!analyzeRes.ok) {
          throw new Error('AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        const analyzeData = await analyzeRes.json();
        const feedback = analyzeData.content;

        // ìŒì„± ë¶„ì„ ê²°ê³¼ ê³„ì‚°
        const recordingDuration = 60 - timeLeft; // ì‹¤ì œ ë…¹ìŒ ì‹œê°„ (ì´ˆ)
        const voiceAnalysis = calculateVoiceAnalysis(transcript, recordingDuration);

        // 3. ê²°ê³¼ ì €ì¥ (ìŒì„± íŒŒì¼ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ - ê°œì¸ì •ë³´ ë³´í˜¸)
        const practice = {
          attempt: practices.length + 1,
          question: question,
          transcript: transcript,
          feedback: feedback,
          voiceAnalysis: voiceAnalysis, // ìŒì„± ë¶„ì„ ë°ì´í„°

          // =======================================================
          // [ì˜ìƒ ë¶„ì„ ë°ì´í„° í•„ë“œ ì¶”ê°€]
          // analysisModeê°€ 'video'ì¼ ë•Œë§Œ videoAnalysisDataë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
          videoAnalysis: analysisMode === 'video' ? { ...videoAnalysisData } : null, // <--- ì´ ì¤„ì„ ì¶”ê°€
          // =======================================================

          timestamp: new Date().toISOString()
        };

        const saveRes = await fetch(API_BASE + '/api/practice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'savePractice',
            interviewId: currentUser.interviewId,
            practice: practice
          })
        });

        if (!saveRes.ok) {
          throw new Error('ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        practices.push(practice);

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('analyzingArea').classList.add('hidden');
        document.getElementById('recordingArea').classList.remove('hidden');

        resetRecording();
        updateProgress();
        renderResults();

        // ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
        showTab('results');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-btn')[1].classList.add('active');

        viewResult(practices.length - 1);

      } catch (err) {
        alert(err.message);
        console.error(err);
        document.getElementById('analyzingArea').classList.add('hidden');
        document.getElementById('recordingArea').classList.remove('hidden');
      }
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // ==================== ë”°ë¼í•˜ê¸° ë…¹ìŒ ====================
    async function toggleSampleRecording() {
      if (!sampleIsRecording) {
        await startSampleRecording();
      } else {
        stopSampleRecording();
      }
    }

    async function startSampleRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        sampleMediaRecorder = new MediaRecorder(stream);
        sampleAudioChunks = [];

        sampleMediaRecorder.ondataavailable = (e) => {
          sampleAudioChunks.push(e.data);
        };

        sampleMediaRecorder.onstop = () => {
          const blob = new Blob(sampleAudioChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          document.getElementById('sampleAudioPlayback').src = url;
          document.getElementById('samplePlayerResult').classList.remove('hidden');
          stream.getTracks().forEach(track => track.stop());
        };

        sampleMediaRecorder.start();
        sampleIsRecording = true;

        const btn = document.getElementById('sampleRecordBtn');
        btn.classList.remove('start');
        btn.classList.add('stop');
        btn.textContent = 'â¹';
        document.getElementById('sampleWaveformOverlay').classList.add('hidden');

        // íŒŒí˜• ì‹œê°í™”
        sampleAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        sampleAnalyser = sampleAudioContext.createAnalyser();
        const source = sampleAudioContext.createMediaStreamSource(stream);
        source.connect(sampleAnalyser);

        sampleAnalyser.fftSize = 256;
        const bufferLength = sampleAnalyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const canvas = document.getElementById('sampleWaveform');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        function draw() {
          sampleAnimationId = requestAnimationFrame(draw);
          sampleAnalyser.getByteFrequencyData(dataArray);

          ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          const barWidth = (canvas.width / bufferLength) * 2.5;
          let x = 0;

          for (let i = 0; i < bufferLength; i++) {
            const barHeight = (dataArray[i] / 255) * canvas.height;
            const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
            gradient.addColorStop(0, '#10B981');
            gradient.addColorStop(1, '#34D399');
            ctx.fillStyle = gradient;
            ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
          }
        }
        draw();

      } catch (err) {
        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        console.error(err);
      }
    }

    function stopSampleRecording() {
      if (sampleMediaRecorder && sampleMediaRecorder.state !== 'inactive') {
        sampleMediaRecorder.stop();
      }

      sampleIsRecording = false;

      if (sampleAnimationId) {
        cancelAnimationFrame(sampleAnimationId);
      }
      if (sampleAudioContext) {
        sampleAudioContext.close();
      }

      const btn = document.getElementById('sampleRecordBtn');
      btn.classList.remove('stop');
      btn.classList.add('start');
      btn.textContent = 'ğŸ¤';
    }

    function resetSampleRecording() {
      document.getElementById('samplePlayerResult').classList.add('hidden');
      document.getElementById('sampleWaveformOverlay').classList.remove('hidden');
      sampleAudioChunks = [];
    }

    // ==================== ì—°ìŠµ ìŒì„± ê´€ë¦¬ ====================
    async function loadSampleAudios() {
      try {
        const res = await fetch(API_BASE + '/api/practice?action=getSampleAudios');
        if (res.ok) {
          const data = await res.json();
          sampleAudios = data.sampleAudios || [];
        }
      } catch (err) {
        console.error('ì—°ìŠµ ìŒì„± ë¡œë“œ ì‹¤íŒ¨:', err);
      }
      renderSampleAudios();
    }

    function renderSampleAudios() {
      const list = document.getElementById('sampleAudioList');
      if (!list) return;

      if (sampleAudios.length === 0) {
        list.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      let html = '';
      sampleAudios.forEach((audio, i) => {
        html += `<div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
      <p style="font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; color: #10B981;">${i + 1}. ${audio.title}</p>
      <audio controls style="width: 100%; margin-bottom: 1rem;">
        <source src="${audio.url}" type="audio/mpeg">
        ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </audio>
      ${audio.script ? `
        <div style="background: rgba(255,255,255,0.05); border-left: 3px solid #10B981; padding: 1rem; border-radius: 0 8px 8px 0;">
          <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">ğŸ“ ìŠ¤í¬ë¦½íŠ¸</p>
          <p style="line-height: 1.8; color: #e8e8e8; white-space: pre-wrap;">${audio.script}</p>
        </div>
      ` : ''}
    </div>`;
      });
      list.innerHTML = html;
    }

    function renderAdminSampleAudios() {
      const list = document.getElementById('adminSampleAudioList');
      if (!list) return;

      if (sampleAudios.length === 0) {
        list.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">ë“±ë¡ëœ ì—°ìŠµ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      let html = '';
      sampleAudios.forEach((audio, i) => {
        html += `<div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div style="flex: 1;">
          <p style="font-weight: 500;">${audio.title}</p>
          <p style="font-size: 0.8rem; color: #666; word-break: break-all;">${audio.url.substring(0, 50)}...</p>
          ${audio.script ? `<p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;">ğŸ“ ìŠ¤í¬ë¦½íŠ¸: ${audio.script.substring(0, 30)}...</p>` : ''}
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteSampleAudio(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`;
      });
      list.innerHTML = html;
    }

    async function addSampleAudio() {
      const title = document.getElementById('sampleAudioTitle').value.trim();
      const url = document.getElementById('sampleAudioUrl').value.trim();
      const script = document.getElementById('sampleAudioScript').value.trim(); // **ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€**

      if (!title || !url) {
        alert('ì œëª©ê³¼ URLì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const newAudio = { title, url, script };
        const res = await fetch(API_BASE + '/api/practice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveSampleAudios',
            sampleAudios: [...sampleAudios, newAudio]
          })
        });

        if (res.ok) {
          sampleAudios.push(newAudio);
          document.getElementById('sampleAudioTitle').value = '';
          document.getElementById('sampleAudioUrl').value = '';
          document.getElementById('sampleAudioScript').value = ''; // **ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™”**
          renderAdminSampleAudios();
          alert('ì—°ìŠµ ìŒì„±ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        console.error(err);
      }
    }

    async function deleteSampleAudio(index) {
      if (!confirm('ì´ ì—°ìŠµ ìŒì„±ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      sampleAudios.splice(index, 1);

      try {
        await fetch(API_BASE + '/api/practice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveSampleAudios',
            sampleAudios: sampleAudios
          })
        });
        renderAdminSampleAudios();
      } catch (err) {
        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        console.error(err);
      }
    }

    // ==================== ê´€ë¦¬ì ê¸°ëŠ¥ ====================
    async function loadAdminData() {
      try {
        const res = await fetch(API_BASE + '/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getAll', adminId: currentUser.interviewId })
        });

        if (!res.ok) {
          throw new Error('ê´€ë¦¬ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

        const data = await res.json();
        renderAdminTable(data.candidates);
        updateStats(data.candidates);

      } catch (err) {
        console.error(err);
        document.getElementById('adminTable').innerHTML =
          '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #EF4444;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderAdminTable(candidates) {
      const tbody = document.getElementById('adminTable');

      if (!candidates || candidates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #666;">ë“±ë¡ëœ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      let html = '';
      candidates.forEach(c => {
        const statusClass = c.count === 0 ? 'not-started' : (c.count >= 3 ? 'completed' : 'in-progress');
        const statusText = c.count === 0 ? 'ë¯¸ì‹œì‘' : (c.count >= 3 ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘');

        html += `<tr>
      <td><strong>${c.interviewId}</strong></td>
      <td>${c.count} / 3 íšŒ</td>
      <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
      <td>${c.lastPractice ? formatDate(c.lastPractice) : '-'}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="viewCandidateDetail('${c.interviewId}')">ìƒì„¸</button>
        ${c.count > 0 ? `<button class="btn btn-sm btn-danger" onclick="resetCandidate('${c.interviewId}')">ì´ˆê¸°í™”</button>` : ''}
      </td>
    </tr>`;
      });

      tbody.innerHTML = html;
    }

    function updateStats(candidates) {
      const total = candidates.length;
      const inProgress = candidates.filter(c => c.count > 0 && c.count < 3).length;
      const completed = candidates.filter(c => c.count >= 3).length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statInProgress').textContent = inProgress;
      document.getElementById('statCompleted').textContent = completed;
    }

    async function resetCandidate(interviewId) {
      if (!confirm(`${interviewId}ë‹˜ì˜ ì—°ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const res = await fetch(API_BASE + '/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'reset', interviewId: interviewId, adminId: currentUser.interviewId })
        });

        if (res.ok) {
          alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadAdminData();
        }
      } catch (err) {
        alert('ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        console.error(err);
      }
    }

    function viewCandidateDetail(interviewId) {
      alert('ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
    }

    function refreshAdmin() {
      loadAdminData();
    }

    // ==================== PDF ë‹¤ìš´ë¡œë“œ ====================
    async function downloadPDF() {
      const title = document.getElementById('detailTitle').textContent;
      const date = document.getElementById('detailDate').textContent;
      const question = document.getElementById('detailQuestion').textContent;
      const transcript = document.getElementById('detailTranscript').textContent;

      // í˜„ì¬ ì„ íƒëœ ì—°ìŠµ ë°ì´í„°ì—ì„œ ì›ë³¸ í”¼ë“œë°± ê°€ì ¸ì˜¤ê¸°
      const selectedCard = document.querySelector('.attempt-card.selected');
      const index = selectedCard ? Array.from(document.querySelectorAll('.attempt-card')).indexOf(selectedCard) : 0;
      const practice = practices[index];
      const feedback = practice ? practice.feedback : '';
      const voiceAnalysis = practice ? practice.voiceAnalysis : null;

      // í”¼ë“œë°± íŒŒì‹±
      const sections = parseFeedback(feedback);

      // ìŒì„± ë¶„ì„ HTML ìƒì„± (í™•ì¥)
      let voiceAnalysisHtml = '';
      if (voiceAnalysis) {
        const getStatusColor = (value, type) => {
          if (type === 'volume') return value >= 60 && value <= 90 ? '#6EE7B7' : (value >= 40 ? '#FCD34D' : '#FCA5A5');
          if (type === 'speaking') return value >= 70 ? '#6EE7B7' : (value >= 50 ? '#93C5FD' : '#FCD34D');
          if (type === 'wpm') return value >= 80 && value <= 120 ? '#6EE7B7' : (value >= 60 && value <= 150 ? '#FCD34D' : '#FCA5A5');
          if (type === 'filler') return value <= 3 ? '#6EE7B7' : (value <= 7 ? '#93C5FD' : '#FCD34D');
          return value >= 70 ? '#6EE7B7' : (value >= 50 ? '#93C5FD' : '#FCD34D');
        };

        // í™•ì¥ ë¶„ì„ ë°ì´í„°
        const fillerWords = voiceAnalysis.fillerWords || { count: 0, ratio: 0, details: [] };
        const longSilences = voiceAnalysis.longSilences || { count: 0 };
        const segmentTrend = voiceAnalysis.segmentTrend || { early: 100, middle: 100, late: 100 };
        const energyLevel = voiceAnalysis.energyLevel || 50;
        const wpmGuide = voiceAnalysis.wpmGuide || '';

        // í•„ëŸ¬ ì›Œë“œ ë¦¬ìŠ¤íŠ¸
        const fillerList = fillerWords.details && fillerWords.details.length > 0
          ? fillerWords.details.map(f => `"${f.word}" ${f.count}íšŒ`).join(', ')
          : 'ì—†ìŒ';

        voiceAnalysisHtml = `
    <!-- ìŒì„± ë¶„ì„ ê²°ê³¼ (í™•ì¥) -->
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
        <span style="background: rgba(139,92,246,0.2); padding: 6px 10px; border-radius: 8px;">ğŸ“Š</span>
        <span style="font-weight: 600; color: #fff;">ìŒì„± ë¶„ì„ ê²°ê³¼</span>
      </div>
      
      <!-- ë§í•˜ê¸° ì†ë„ & ê°€ì´ë“œ -->
      <div style="background: rgba(0,0,0,0.3); padding: 14px; border-radius: 10px; margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #fff; font-size: 13px; font-weight: 600;">âš¡ ë§í•˜ê¸° ì†ë„</span>
          <span style="color: ${getStatusColor(voiceAnalysis.wpm, 'wpm')}; font-size: 13px; font-weight: 600;">ë¶„ë‹¹ ${voiceAnalysis.wpm}ë‹¨ì–´</span>
        </div>
        <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-bottom: 10px;">
          <div style="width: ${Math.min(100, (voiceAnalysis.wpm / 150) * 100)}%; height: 100%; background: ${getStatusColor(voiceAnalysis.wpm, 'wpm')}; border-radius: 3px;"></div>
        </div>
        <div style="font-size: 11px; color: #ccc; margin-bottom: 8px;">í•œêµ­ì–´ ê¸°ì¤€ 80~120 WPMì´ ì ë‹¹</div>
        ${wpmGuide ? `<div style="background: rgba(59,130,246,0.1); border-left: 3px solid #3B82F6; padding: 8px 12px; border-radius: 0 6px 6px 0; font-size: 12px; color: #fff;">ğŸ’¬ ${wpmGuide}</div>` : ''}
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
        <!-- í•„ëŸ¬ ì›Œë“œ -->
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <span style="color: #fff; font-size: 12px;">ğŸ—£ï¸ í•„ëŸ¬ ì›Œë“œ</span>
            <span style="color: ${getStatusColor(fillerWords.ratio, 'filler')}; font-size: 12px; font-weight: 600;">${fillerWords.count}íšŒ (${fillerWords.ratio}%)</span>
          </div>
          <div style="font-size: 11px; color: #ccc; margin-top: 4px;">${fillerList}</div>
        </div>
        
        <!-- ê¸´ ì¹¨ë¬µ -->
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <span style="color: #fff; font-size: 12px;">â¸ï¸ ê¸´ ì¹¨ë¬µ (2ì´ˆ+)</span>
            <span style="color: ${longSilences.count === 0 ? '#6EE7B7' : '#FCD34D'}; font-size: 12px; font-weight: 600;">${longSilences.count}íšŒ</span>
          </div>
          <div style="font-size: 11px; color: #ccc;">2ì´ˆ ì´ìƒ ë©ˆì¶˜ íšŸìˆ˜</div>
        </div>
        
        <!-- ì—ë„ˆì§€ ë ˆë²¨ -->
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <span style="color: #fff; font-size: 12px;">ğŸ”¥ ì—ë„ˆì§€ ë ˆë²¨</span>
            <span style="color: ${energyLevel >= 60 ? '#6EE7B7' : (energyLevel >= 40 ? '#93C5FD' : '#FCD34D')}; font-size: 12px; font-weight: 600;">${energyLevel}%</span>
          </div>
          <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
            <div style="width: ${energyLevel}%; height: 100%; background: ${energyLevel >= 60 ? '#6EE7B7' : (energyLevel >= 40 ? '#93C5FD' : '#FCD34D')}; border-radius: 3px;"></div>
          </div>
        </div>
        
        <!-- ë§í•˜ê¸° ë¹„ìœ¨ -->
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <span style="color: #fff; font-size: 12px;">ğŸ’¬ ë§í•˜ê¸° ë¹„ìœ¨</span>
            <span style="color: ${getStatusColor(voiceAnalysis.speakingRatio, 'speaking')}; font-size: 12px; font-weight: 600;">${voiceAnalysis.speakingRatio}%</span>
          </div>
          <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
            <div style="width: ${voiceAnalysis.speakingRatio}%; height: 100%; background: ${getStatusColor(voiceAnalysis.speakingRatio, 'speaking')}; border-radius: 3px;"></div>
          </div>
        </div>
      </div>
    </div>
    `;
      }

      // PDFìš© HTML ìƒì„± (ì–´ë‘ìš´ í…Œë§ˆ)
      const printArea = document.createElement('div');
      printArea.style.cssText = 'padding: 30px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e8e8e8; font-family: "Noto Sans KR", sans-serif; width: 210mm;';

      printArea.innerHTML = `
    <h1 style="color: #10B981; border-bottom: 2px solid #10B981; padding-bottom: 15px; font-size: 24px; margin-bottom: 10px;">ğŸ¯ ë©´ì ‘ ëª¨ì˜ì—°ìŠµ ê²°ê³¼</h1>
    <p style="color: #888; font-size: 14px; margin-bottom: 25px;">${title} | ${date} | ë©´ì ‘ë²ˆí˜¸: ${currentUser.interviewId}</p>
    
    ${voiceAnalysisHtml}
    
    <!-- ì§ˆë¬¸ -->
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
        <span style="background: rgba(59,130,246,0.2); padding: 6px 10px; border-radius: 8px;">ğŸ“‹</span>
        <span style="font-weight: 600; color: #ccc;">ì§ˆë¬¸</span>
      </div>
      <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; color: #ddd; line-height: 1.8;">${question}</div>
    </div>
    
    <!-- ë‚˜ì˜ ë‹µë³€ -->
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
        <span style="background: rgba(16,185,129,0.2); padding: 6px 10px; border-radius: 8px;">ğŸ¤</span>
        <span style="font-weight: 600; color: #ccc;">ë‚˜ì˜ ë‹µë³€ (ìŒì„±â†’í…ìŠ¤íŠ¸)</span>
      </div>
      <p style="font-size: 12px; color: #F59E0B; margin-bottom: 8px;">âš ï¸ ë…¹ìŒ ìŒì„±ì„ AIê°€ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•œ ê²°ê³¼ë¡œ, ì£¼ë³€ í™˜ê²½(ì†ŒìŒ, ì—ì½” ë“±)ì— ë”°ë¼ ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; color: #ddd; line-height: 1.8;">${transcript}</div>
    </div>
    
    <!-- AI í”¼ë“œë°± -->
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
        <span style="background: rgba(245,158,11,0.2); padding: 6px 10px; border-radius: 8px;">ğŸ’¡</span>
        <span style="font-weight: 600; color: #ccc;">AI í”¼ë“œë°±</span>
      </div>
      <p style="font-size: 12px; color: #F59E0B; margin-bottom: 15px;">âš ï¸ ë³¸ AIë¶„ì„ì€ ìŒì„± ë³€í™˜ê³¼ AI ì²˜ë¦¬ì— ê¸°ë°˜í•˜ë¯€ë¡œ, ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì°¸ê³  ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
      
      <!-- í”¼ë“œë°± ì¹´ë“œ ê·¸ë¦¬ë“œ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <!-- ë‹µë³€ì˜ ì ì ˆì„± -->
        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
          <div style="background: rgba(59,130,246,0.2); padding: 10px 12px; color: #93C5FD; font-weight: 600; font-size: 14px;">ğŸ“‹ ë‹µë³€ì˜ ì ì ˆì„±</div>
          <div style="padding: 12px; color: #ddd; font-size: 13px; line-height: 1.7;">${sections.relevance || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
        </div>
        
        <!-- ê°•ì  -->
        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
          <div style="background: rgba(16,185,129,0.2); padding: 10px 12px; color: #6EE7B7; font-weight: 600; font-size: 14px;">âœ… ê°•ì  (ì˜í•œ ë¶€ë¶„)</div>
          <div style="padding: 12px; color: #ddd; font-size: 13px; line-height: 1.7;">${sections.strength || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
        </div>
        
        <!-- ê°œì„ ì  -->
        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
          <div style="background: rgba(245,158,11,0.2); padding: 10px 12px; color: #FCD34D; font-weight: 600; font-size: 14px;">ğŸ”§ ê°œì„ ì  (ë³´ì™„í•  ë¶€ë¶„)</div>
          <div style="padding: 12px; color: #ddd; font-size: 13px; line-height: 1.7;">${sections.improvement || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
        </div>
        
        <!-- ê°œì„  ì œì•ˆ -->
        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
          <div style="background: rgba(139,92,246,0.2); padding: 10px 12px; color: #C4B5FD; font-weight: 600; font-size: 14px;">ğŸ’ êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ</div>
          <div style="padding: 12px; color: #ddd; font-size: 13px; line-height: 1.7;">${sections.suggestion || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
        </div>
      </div>
    </div>
    
    <p style="margin-top: 30px; color: #666; font-size: 11px; text-align: center;">
      â€» ë³¸ ë¶„ì„ì€ AIê°€ ì‘ì„±í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤. ë©´ì ‘ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ì§„ì •ì„±ê³¼ ì¤€ë¹„ì„±ì…ë‹ˆë‹¤! ğŸ’ª
    </p>
  `;

      document.body.appendChild(printArea);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = doc.internal.pageSize.getHeight();

      try {
        const canvas = await html2canvas(printArea, { scale: 2, backgroundColor: '#1a1a2e' });
        const imgData = canvas.toDataURL('image/png');
        const imgHeight = (canvas.height * pdfWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 0;

        doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
        heightLeft -= pdfHeight;

        while (heightLeft >= -50) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
          heightLeft -= pdfHeight;
        }

        doc.save(`ë©´ì ‘ì—°ìŠµ_${currentUser.interviewId}_${title}.pdf`);
      } catch (error) {
        console.error("PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        document.body.removeChild(printArea);
      }
    }

    // ==================== ìœ í‹¸ë¦¬í‹° ====================
    function formatDate(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return d.toLocaleDateString('ko-KR') + ' ' + d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '...' : str;
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>

</html>